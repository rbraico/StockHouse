{% extends 'layout.html' %}

{% block content %}

<style>
    .card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        border-top: 1px solid #dee2e6;
        background-color: #f8f9fa;
    }

    #deleteSelectedBtn,
    #finalizeListBtn,
    #addManualBtn {
        min-width: 160px;
        font-weight: 500;
    }

    .card {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .card-body {
        flex-grow: 1;
        overflow-y: auto;
    }

    .table-responsive {
        max-height: 250px;
        min-height: 150px; /* Previene il collasso con poche righe */
        overflow-y: auto;
    }

</style>


<h2 class="text-center">üç≠Ô∏è Lista della Spesa</h2>
<br>
<div class="mb-3 text-center fw-bold fs-5 text-primary">
    üìÖ Periodo: {{ period_label }}
</div>

<!-- Definisce le due tabs -->
<ul class="nav nav-tabs mt-3" id="shoppingTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list" type="button" role="tab" aria-controls="list" aria-selected="true">
      üõí Lista della Spesa
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="receipt-tab" data-bs-toggle="tab" data-bs-target="#receipt" type="button" role="tab" aria-controls="receipt" aria-selected="false">
      üìÑ Importa Scontrino
    </button>
  </li>
</ul>

<div class="tab-content" id="shoppingTabsContent">
  <div class="tab-pane fade show active" id="list" role="tabpanel" aria-labelledby="list-tab">
    <!-- Qui sposti le 4 tabelle esistenti della lista della spesa -->
    <div class="container-fluid">
        <div class="row mb-4">
            <!-- Prodotti Consigliati -->
            <div class="col-md-6">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                        <span>‚ö†Ô∏è Prodotti Consigliati</span>
                        <select id="itemTypeFilter" class="form-select form-select-sm w-auto" onchange="filterSuggestedTable()">
                            <option value="">Tutti i tipi</option>
                            {% set tipi = suggested_items | map(attribute='item_type') | unique | list | sort %}
                            {% for tipo in tipi %}
                            <option value="{{ tipo }}">{{ tipo }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                        <table id="suggestedTable" class="table table-sm table-striped mb-0">   
                            <thead class="table-warning sticky-top">
                                <tr>
                                    <th>Seleziona</th>
                                    <th>Prodotto</th>
                                    <th>Immagine</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in suggested_items %}
                                <tr 
                                    data-item-type="{{ item.item_type }}" 
                                    data-price="{{ item.price or 0 }}" 
                                    data-quantity="{{ item.quantity or 1 }}"
                                    data-barcode="{{ item.barcode }}"
                                    data-name="{{ item.product_name }}"
                                    data-shop="{{ item.shop }}"
                                >
                                    <td>
                                        <input type="checkbox" class="suggested-checkbox" value="{{ item.barcode }}">
                                    </td>
                                    <td>
                                        {{ item.product_name }}
                                        {% if item.quantity|int > 1 %}
                                            üõí
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.image_url %}
                                        <img src="{{ item.image_url }}" alt="{{ item.product_name }}" style="max-height: 40px;">
                                        {% else %}
                                        <span class="text-muted">Nessuna immagine</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">Nessun prodotto suggerito al momento.</td>
                                </tr>
                                {% endfor %}
                            </tbody>

   
                        </table>
                    </div>

                    <div class="card-footer d-flex justify-content-between">
                        <button id="addSelectedBtn" class="btn btn-success">‚ûï Aggiungi selezionati</button>
                        <button id="addManualBtn" class="btn btn-warning">‚úèÔ∏è Aggiungi manualmente</button>
                    </div>
                </div>
            </div>


            <!-- Lista della Spesa -->
            <div class="col-md-6">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        üõí Lista della Spesa
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" id="shoppingListContainer" style="max-height: 250px; overflow-y: auto;">
                            {% include 'shopping_list_table.html' %}
                        </div>
                    </div>
                    <div class="card-footer d-flex justify-content-between">
                        <button id="deleteSelectedBtn" class="btn btn-danger">üóëÔ∏è Rimuovi selezionati</button>
                        <button id="finalizeListBtn" class="btn btn-primary">‚úÖ Finalizza Lista</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Riga 2 -->
        <div class="row mb-4">
            <!-- Colonna 1: Totale per negozio -->
            <div class="col-md-6" id="shopTotalsContainer">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        üè™ Totale Spesa per Negozio
                    </div>
                    <div style="max-height: 180px; overflow-y: auto;">
                        <ul class="list-group list-group-flush">
                            {% for store, total in shop_totals.items() %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ store }}
                                <span>‚Ç¨ {{ '%.2f'|format(total) }}</span>
                            </li>
                            {% else %}
                            <li class="list-group-item text-center text-muted">
                                Nessun negozio selezionato.
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Colonna 2: Riepilogo budget -->
            <div class="col-md-6">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>üí∂ Budget mensile: ‚Ç¨ {{ budget }}</span>
                            {% set percent_used = (spesa_corrente / budget * 100) if budget > 0 else 0 %}
                            <div class="progress w-50 ms-3" style="height: 20px;">
                                <div class="progress-bar 
                                    {% if percent_used < 70 %} bg-success
                                    {% elif percent_used < 90 %} bg-warning
                                    {% else %} bg-danger
                                    {% endif %} "
                                    role="progressbar" style="width: {{ percent_used|round(1) }}%;" aria-valuenow="{{ percent_used|round(1) }}" aria-valuemin="0" aria-valuemax="100">
                                    {{ percent_used|round(1) }}%
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered text-center mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Decade</th>
                                    <th>%</th>
                                    <th>Budget disponibile</th>
                                    <th>Spesi</th>
                                    <th>Bilancio</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set dec_percent = [budget_record['decade1'], budget_record['decade2'], budget_record['decade3']] %}
                                {% set budget_total = budget_record['budget'] %}
                                {% set bilancio_prec = 0 %}
                                {% set dec_num = current_decade[1]|int %}
                                {% set bilancio_precedente = [0, 0, 0] %}
                                {% for i in range(3) %}
                                    {% set label = 'D' ~ (i+1) %}
                                    {% set perc = dec_percent[i] %}
                                    {% set quota = (budget_total * perc / 100)|round(2) %}
                                    {% set spesi = spesa_decade[i]|round(2) %}
                                    {% if i == 0 %}
                                        {% set previsto = quota %}
                                        {% set bilancio = previsto - spesi %}
                                    {% elif i + 1 > dec_num %}
                                        {% set previsto = quota %}
                                        {% set bilancio = 0 %}
                                    {% else %}
                                        {% if spesi > 0 or (i + 1 == dec_num) %}
                                            {% set previsto = (quota + bilancio_precedente[i-1])|round(2) %}
                                        {% else %}
                                            {% set previsto = quota %}
                                        {% endif %}
                                        {% if spesi > 0 %}
                                            {% set bilancio = previsto - spesi %}
                                        {% else %}
                                            {% set bilancio = previsto %}
                                        {% endif %}
                                    {% endif %}
                                    {% set _ = bilancio_precedente.__setitem__(i, bilancio) %}
                                    <tr {% if dec_num == i + 1 %} class="table-primary fw-bold" {% endif %}>
                                        <td>{{ label }}</td>
                                        <td>{{ perc }}%</td>
                                        <td>‚Ç¨ {{ previsto }}</td>
                                        <td>‚Ç¨ {{ spesi }}</td>
                                        <td style="color: {{ 'green' if bilancio >= 0 else 'red' }}">
                                            ‚Ç¨ {{ bilancio|round(2) }}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal per inserimento quantit√† prodotti consigliati -->
    <div class="modal fade" id="selectedItemsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">Quantit√† prodotti</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
        </div>
        <div class="modal-body">
            <table class="table table-sm" id="selectedItemsModalBody">
                <thead>
                    <tr>
                        <th>Prodotto</th>
                        <th>Quantit√†</th>
                        <th>Prezzo</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Riempito dinamicamente via JS -->
                </tbody>
            </table>
        </div>
        <div class="modal-footer">
            <button type="button" id="confirmAddBtn" class="btn btn-success">Aggiungi</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
        </div>
        </div>
    </div>
    </div>
    

    <!-- Modal per aggiunta manuale prodotto -->
    <div class="modal fade" id="manualAddModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">Aggiungi prodotto manualmente</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
        </div>
        <div class="modal-body">
            <form id="manualAddForm">
                <div class="mb-3">
                    <label class="form-label">Nome prodotto</label>
                    <input type="text" class="form-control" id="manualProductName" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Quantit√†</label>
                    <input type="number" class="form-control" id="manualProductQty" min="1" value="1" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Negozio</label>
                    <input type="text" class="form-control" id="manualProductShop">
                </div>
                <div class="mb-3">
                    <label class="form-label">Prezzo (‚Ç¨)</label>
                    <input type="number" step="0.01" class="form-control" id="manualProductPrice">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" id="confirmManualAddBtn" class="btn btn-success">Aggiungi</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
        </div>
        </div>
    </div>
    </div>

</div>

<!-- üìÑ Importa scontrino -->
    <div class="tab-pane fade" id="receipt" role="tabpanel" aria-labelledby="receipt-tab">
    <div class="p-3">
        <h5>Trascina qui il tuo scontrino</h5>
        <div id="drop-zone" class="border border-primary rounded p-5 text-center" style="background-color: #f8f9fa;">
        üì• Trascina il file qui oppure clicca per selezionarlo
        </div>
        <input type="file" id="file-input" style="display:none;" accept=".jpg,.png,.jpeg,.pdf"/>
        <div id="upload-status" class="mt-3"></div>

        <img id="image-preview" class="receipt-preview" style="display:none; max-width:100%; margin-top:15px; border:1px solid #dee2e6;" />
        <iframe id="pdf-preview" class="receipt-preview" style="display:none; width:100%; height:500px;"></iframe>

        <div id="action-buttons" class="mt-3" style="display:none;">
        <button id="analyze-btn" class="btn btn-primary me-2">Analizza scontrino</button>
        <button id="delete-btn" class="btn btn-danger">Elimina scontrino</button>
        </div>
    </div>
    </div>

</div>




<script>
document.getElementById('addSelectedBtn').addEventListener('click', function () {
    const checkboxes = document.querySelectorAll('.suggested-checkbox:checked');
    const selectedItems = Array.from(checkboxes).map(cb => {
        const row = cb.closest('tr');
        console.log("Prezzo letto dal dataset:", row.dataset.price);  
        return {
            barcode: cb.value,
            name: row.querySelectorAll('td')[1].textContent.trim(),
            price: parseFloat(row.dataset.price) || 0,
            quantity: parseInt(row.dataset.quantity) || 1
        };
    });

    if (selectedItems.length === 0) return;

    const modalBodyTbody = document.getElementById('selectedItemsModalBody').querySelector('tbody');
    modalBodyTbody.innerHTML = '';

    selectedItems.forEach(item => {
        const tr = document.createElement('tr');

        // Nome prodotto
        const tdName = document.createElement('td');
        tdName.textContent = item.name;

        // Quantit√†
        const tdQuantity = document.createElement('td');
        const inputQty = document.createElement('input');
        inputQty.type = 'number';
        inputQty.className = 'form-control quantity-input';
        inputQty.min = 1;
        inputQty.value = item.quantity;
        inputQty.dataset.barcode = item.barcode;
        tdQuantity.appendChild(inputQty);

        // Prezzo (precompilato)
        const tdPrice = document.createElement('td');
        const inputPrice = document.createElement('input');
        inputPrice.type = 'number';
        inputPrice.className = 'form-control price-input';
        inputPrice.step = '0.01';
        inputPrice.min = '0';
        inputPrice.value = item.price.toFixed(2);
        inputPrice.dataset.barcode = item.barcode;
        tdPrice.appendChild(inputPrice);

        tr.appendChild(tdName);
        tr.appendChild(tdQuantity);
        tr.appendChild(tdPrice);

        modalBodyTbody.appendChild(tr);
    });

    const modal = new bootstrap.Modal(document.getElementById('selectedItemsModal'));
    modal.show();

    checkboxes.forEach(cb => cb.checked = false);
});

document.getElementById('confirmAddBtn').addEventListener('click', async function () {
    const qtyInputs = document.querySelectorAll('.quantity-input');
    const priceInputs = document.querySelectorAll('.price-input');

    const itemsToAdd = Array.from(qtyInputs).map((input, index) => ({
        barcode: input.dataset.barcode,
        quantity: parseInt(input.value),
        price: parseFloat(priceInputs[index].value) || 0
    }));

    // üîç Log per verifica
    console.log("Conferma invio:", itemsToAdd);

    const response = await fetch('/shopping_list/add_selected', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: itemsToAdd })
    });

    if (response.ok) {
        const data = await response.json();
        document.getElementById('shoppingListContainer').innerHTML = data.shopping_list_html;
        document.getElementById('shopTotalsContainer').innerHTML = data.shop_totals_html;
    }

    const modal = bootstrap.Modal.getInstance(document.getElementById('selectedItemsModal'));
    modal.hide();
});


// --- Aggiunta manuale prodotto ---
document.getElementById('addManualBtn').addEventListener('click', function () {
    document.getElementById('manualAddForm').reset();
    const modal = new bootstrap.Modal(document.getElementById('manualAddModal'));
    modal.show();
});

document.getElementById('confirmManualAddBtn').addEventListener('click', async function () {
    const name = document.getElementById('manualProductName').value.trim();
    const quantity = parseInt(document.getElementById('manualProductQty').value);
    const shop = document.getElementById('manualProductShop').value.trim();
    const price = parseFloat(document.getElementById('manualProductPrice').value) || 0;

    if (!name || quantity < 1) return alert("Inserisci nome e quantit√† validi.");

    // Prepariamo i dati nello stesso formato di add_selected, usando il nome come barcode
    const itemsToAdd = [{
        barcode: name,  // barcode impostato al nome del prodotto
        name: name,
        quantity: quantity,
        shop: shop,
        price: price
    }];

    const response = await fetch('/shopping_list/add_selected', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: itemsToAdd })
    });

    if (response.ok) {
        const data = await response.json();
        document.getElementById('shoppingListContainer').innerHTML = data.shopping_list_html;
        document.getElementById('shopTotalsContainer').innerHTML = data.shop_totals_html;
    }

    const modal = bootstrap.Modal.getInstance(document.getElementById('manualAddModal'));
    modal.hide();
});



// --- Rimuovi selezionati ---
document.getElementById('deleteSelectedBtn').addEventListener('click', async function () {
    const checkboxes = document.querySelectorAll('.shopping-checkbox:checked');
    const selectedBarcodes = Array.from(checkboxes).map(cb => cb.value);

    if (selectedBarcodes.length === 0) return;

    const response = await fetch('/shopping_list/remove_selected', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ barcodes: selectedBarcodes })
    });

    if (response.ok) {
        const data = await response.json();
        document.getElementById('shoppingListContainer').innerHTML = data.shopping_list_html;
        document.getElementById('shopTotalsContainer').innerHTML = data.shop_totals_html;
    }
});

// --- Finalizza lista ---
document.getElementById('finalizeListBtn').addEventListener('click', async function () {
    const response = await fetch('/shopping_list/finalize', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    });

    if (response.ok) {
        alert("Lista finalizzata: l'ordinamento dei reparti verr√† calcolato in background.");
    } else {
        alert("Errore durante la finalizzazione della lista.");
    }
});
</script>


<!-- Importa scontrino-->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const dropZone = document.getElementById('drop-zone');
  const fileInput = document.getElementById('file-input');
  const statusDiv = document.getElementById('upload-status');
  const actionButtons = document.getElementById('action-buttons');
  const analyzeBtn = document.getElementById('analyze-btn');
  const deleteBtn = document.getElementById('delete-btn');
  const imagePreview = document.getElementById('image-preview');
  const pdfPreview = document.getElementById('pdf-preview');
  const allPreviews = document.querySelectorAll('.receipt-preview');
  let uploadedFilename = null;

  dropZone.addEventListener('click', () => fileInput.click());
  dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.style.backgroundColor = '#e0f7ff'; });
  dropZone.addEventListener('dragleave', e => { e.preventDefault(); dropZone.style.backgroundColor = '#f8f9fa'; });
  dropZone.addEventListener('drop', e => {
    e.preventDefault();
    dropZone.style.backgroundColor = '#f8f9fa';
    handleFileUpload(e.dataTransfer.files[0]);
  });
  fileInput.addEventListener('change', e => handleFileUpload(e.target.files[0]));

  function handleFileUpload(file) {
    if (!file) return;
    const formData = new FormData();
    formData.append('file', file);
    allPreviews.forEach(el => el.style.display = 'none');

    if (!file.type.startsWith('image/') && file.type !== 'application/pdf') {
      statusDiv.textContent = `Errore: Formato non supportato.`;
      actionButtons.style.display = 'none';
      return;
    }

    fetch('/import_receipt', { method: 'POST', body: formData })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          uploadedFilename = data.filename;
          statusDiv.textContent = `File caricato: ${uploadedFilename}`;
          actionButtons.style.display = 'block';

          if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function (e) {
              imagePreview.src = e.target.result;
              imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
          } else {
            const fileURL = URL.createObjectURL(file);
            pdfPreview.src = fileURL;
            pdfPreview.style.display = 'block';
          }
        } else {
          statusDiv.textContent = `Errore: ${data.msg}`;
          actionButtons.style.display = 'none';
        }
      })
      .catch(err => {
        statusDiv.textContent = `Errore upload: ${err}`;
        actionButtons.style.display = 'none';
      });
  }

  analyzeBtn.addEventListener('click', () => {
    if (!uploadedFilename) return;
    fetch(`/analyze_receipt?filename=${encodeURIComponent(uploadedFilename)}`)
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert('Scontrino analizzato (simulazione). Dati ricevuti da Gemini AI!');
          console.log(data);
        } else alert('Errore durante l‚Äôanalisi.');
      })
      .catch(err => alert('Errore chiamata analyze_receipt: ' + err));
  });

  deleteBtn.addEventListener('click', () => {
    fetch('/delete_receipt', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ filename: uploadedFilename })
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          statusDiv.textContent = 'Scontrino eliminato con successo.';
          actionButtons.style.display = 'none';
          allPreviews.forEach(el => el.style.display = 'none');
          uploadedFilename = null;
        } else {
          statusDiv.textContent = `Errore eliminazione: ${data.msg}`;
        }
      })
      .catch(err => {
        statusDiv.textContent = `Errore chiamata delete_receipt: ${err}`;
        console.error(err);
      });
  });
});
</script>

<!-- Tabella prodotti consigliati - Questo script seleziona i prodotti in base al filtro-->
<script>
    function filterSuggestedTable() {
        const filtro = document.getElementById("itemTypeFilter").value;
        const tabella = document.querySelector("#suggestedTable"); // ID specifico
        const righe = tabella.querySelectorAll("tbody tr");

        righe.forEach(riga => {
            const tipo = riga.getAttribute("data-item-type");
            riga.style.display = (!filtro || tipo === filtro) ? "" : "none";
        });
    }
 </script>




{% endblock %}
