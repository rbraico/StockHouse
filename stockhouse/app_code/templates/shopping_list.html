{% extends 'layout.html' %}

{% block content %}

<style>
    .card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        border-top: 1px solid #dee2e6;
        background-color: #f8f9fa;
    }

    #deleteSelectedBtn,
    #finalizeListBtn,
    #addManualBtn {
        min-width: 160px;
        font-weight: 500;
    }

    .card {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .card-body {
        flex-grow: 1;
        overflow-y: auto;
    }
</style>

<h2 class="text-center">üç≠Ô∏è Lista della Spesa</h2>
<br>
<div class="mb-3 text-center fw-bold fs-5 text-primary">
    üìÖ Periodo: {{ period_label }}
</div>

<div class="container-fluid">
    <div class="row mb-4">
        <!-- Prodotti Consigliati -->
        <div class="col-md-6">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    ‚ö†Ô∏è Prodotti Consigliati da Aggiungere
                </div>
                <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                    <table class="table table-sm table-striped mb-0">
                        <thead class="table-warning sticky-top">
                            <tr>
                                <th>Seleziona</th>
                                <th>Prodotto</th>
                                <th>Motivo</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in suggested_items %}
                            <tr>
                                <td><input type="checkbox" class="suggested-checkbox" value="{{ item.barcode }}"></td>
                                <td>{{ item.product_name }}</td>
                                <td>{{ item.reason }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="3" class="text-center text-muted">Nessun prodotto suggerito al momento.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="card-footer d-flex justify-content-between">
                    <button id="addSelectedBtn" class="btn btn-success">‚ûï Aggiungi selezionati</button>
                    <button id="addManualBtn" class="btn btn-warning">‚úèÔ∏è Aggiungi manualmente</button>
                </div>
            </div>
        </div>

        <!-- Lista della Spesa -->
        <div class="col-md-6">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    üõí Lista della Spesa
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" id="shoppingListContainer" style="max-height: 250px; overflow-y: auto;">
                        {% include 'shopping_list_table.html' %}
                    </div>
                </div>
                <div class="card-footer d-flex justify-content-between">
                    <button id="deleteSelectedBtn" class="btn btn-danger">üóëÔ∏è Rimuovi selezionati</button>
                    <button id="finalizeListBtn" class="btn btn-primary">‚úÖ Finalizza Lista</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Riga 2 -->
    <div class="row mb-4">
        <!-- Colonna 1: Totale per negozio -->
        <div class="col-md-6" id="shopTotalsContainer">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    üè™ Totale Spesa per Negozio
                </div>
                <div style="max-height: 180px; overflow-y: auto;">
                    <ul class="list-group list-group-flush">
                        {% for store, total in shop_totals.items() %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ store }}
                            <span>‚Ç¨ {{ '%.2f'|format(total) }}</span>
                        </li>
                        {% else %}
                        <li class="list-group-item text-center text-muted">
                            Nessun negozio selezionato.
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <!-- Colonna 2: Riepilogo budget -->
        <div class="col-md-6">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>üí∂ Budget mensile: ‚Ç¨ {{ budget }}</span>
                        {% set percent_used = (spesa_corrente / budget * 100) if budget > 0 else 0 %}
                        <div class="progress w-50 ms-3" style="height: 20px;">
                            <div class="progress-bar 
                                {% if percent_used < 70 %} bg-success
                                {% elif percent_used < 90 %} bg-warning
                                {% else %} bg-danger
                                {% endif %} "
                                role="progressbar" style="width: {{ percent_used|round(1) }}%;" aria-valuenow="{{ percent_used|round(1) }}" aria-valuemin="0" aria-valuemax="100">
                                {{ percent_used|round(1) }}%
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered text-center mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Decade</th>
                                <th>%</th>
                                <th>Budget disponibile</th>
                                <th>Spesi</th>
                                <th>Bilancio</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set dec_percent = [budget_record['decade1'], budget_record['decade2'], budget_record['decade3']] %}
                            {% set budget_total = budget_record['budget'] %}
                            {% set bilancio_prec = 0 %}
                            {% set dec_num = current_decade[1]|int %}
                            {% set bilancio_precedente = [0, 0, 0] %}
                            {% for i in range(3) %}
                                {% set label = 'D' ~ (i+1) %}
                                {% set perc = dec_percent[i] %}
                                {% set quota = (budget_total * perc / 100)|round(2) %}
                                {% set spesi = spesa_decade[i]|round(2) %}
                                {% if i == 0 %}
                                    {% set previsto = quota %}
                                    {% set bilancio = previsto - spesi %}
                                {% elif i + 1 > dec_num %}
                                    {% set previsto = quota %}
                                    {% set bilancio = 0 %}
                                {% else %}
                                    {% if spesi > 0 or (i + 1 == dec_num) %}
                                        {% set previsto = (quota + bilancio_precedente[i-1])|round(2) %}
                                    {% else %}
                                        {% set previsto = quota %}
                                    {% endif %}
                                    {% if spesi > 0 %}
                                        {% set bilancio = previsto - spesi %}
                                    {% else %}
                                        {% set bilancio = previsto %}
                                    {% endif %}
                                {% endif %}
                                {% set _ = bilancio_precedente.__setitem__(i, bilancio) %}
                                <tr {% if dec_num == i + 1 %} class="table-primary fw-bold" {% endif %}>
                                    <td>{{ label }}</td>
                                    <td>{{ perc }}%</td>
                                    <td>‚Ç¨ {{ previsto }}</td>
                                    <td>‚Ç¨ {{ spesi }}</td>
                                    <td style="color: {{ 'green' if bilancio >= 0 else 'red' }}">
                                        ‚Ç¨ {{ bilancio|round(2) }}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal per inserimento quantit√† prodotti consigliati -->
<div class="modal fade" id="selectedItemsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Quantit√† prodotti</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body">
        <table class="table table-sm" id="selectedItemsModalBody">
            <thead>
                <tr>
                    <th>Prodotto</th>
                    <th>Quantit√†</th>
                </tr>
            </thead>
            <tbody>
                <!-- Riempito dinamicamente via JS -->
            </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" id="confirmAddBtn" class="btn btn-success">Aggiungi</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal per aggiunta manuale prodotto -->
<div class="modal fade" id="manualAddModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Aggiungi prodotto manualmente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body">
        <form id="manualAddForm">
            <div class="mb-3">
                <label class="form-label">Nome prodotto</label>
                <input type="text" class="form-control" id="manualProductName" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Quantit√†</label>
                <input type="number" class="form-control" id="manualProductQty" min="1" value="1" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Negozio</label>
                <input type="text" class="form-control" id="manualProductShop">
            </div>
            <div class="mb-3">
                <label class="form-label">Prezzo (‚Ç¨)</label>
                <input type="number" step="0.01" class="form-control" id="manualProductPrice">
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" id="confirmManualAddBtn" class="btn btn-success">Aggiungi</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
      </div>
    </div>
  </div>
</div>

<script>
// --- Prodotti consigliati ---
document.getElementById('addSelectedBtn').addEventListener('click', function () {
    const checkboxes = document.querySelectorAll('.suggested-checkbox:checked');
    const selectedItems = Array.from(checkboxes).map(cb => ({
        barcode: cb.value,
        name: cb.closest('tr').querySelectorAll('td')[1].textContent.trim(),
        quantity: 1
    }));

    if (selectedItems.length === 0) return;

    const modalBodyTbody = document.getElementById('selectedItemsModalBody').querySelector('tbody');
    modalBodyTbody.innerHTML = '';
    selectedItems.forEach(item => {
        const tr = document.createElement('tr');

        const tdName = document.createElement('td');
        tdName.textContent = item.name;

        const tdQuantity = document.createElement('td');
        const input = document.createElement('input');
        input.type = 'number';
        input.className = 'form-control quantity-input';
        input.min = 1;
        input.value = item.quantity;
        input.dataset.barcode = item.barcode;
        tdQuantity.appendChild(input);

        tr.appendChild(tdName);
        tr.appendChild(tdQuantity);

        modalBodyTbody.appendChild(tr);
    });

    const modal = new bootstrap.Modal(document.getElementById('selectedItemsModal'));
    modal.show();

    // Deseleziona i checkbox
    checkboxes.forEach(cb => cb.checked = false);
});

document.getElementById('confirmAddBtn').addEventListener('click', async function () {
    const inputs = document.querySelectorAll('.quantity-input');
    const itemsToAdd = Array.from(inputs).map(input => ({
        barcode: input.dataset.barcode,
        quantity: parseInt(input.value)
    }));

    const response = await fetch('/shopping_list/add_selected', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: itemsToAdd })
    });

    if (response.ok) {
        const data = await response.json();
        document.getElementById('shoppingListContainer').innerHTML = data.shopping_list_html;
        document.getElementById('shopTotalsContainer').innerHTML = data.shop_totals_html;
    }

    const modal = bootstrap.Modal.getInstance(document.getElementById('selectedItemsModal'));
    modal.hide();
});

// --- Aggiunta manuale prodotto ---
document.getElementById('addManualBtn').addEventListener('click', function () {
    document.getElementById('manualAddForm').reset();
    const modal = new bootstrap.Modal(document.getElementById('manualAddModal'));
    modal.show();
});

document.getElementById('confirmManualAddBtn').addEventListener('click', async function () {
    const name = document.getElementById('manualProductName').value.trim();
    const quantity = parseInt(document.getElementById('manualProductQty').value);
    const shop = document.getElementById('manualProductShop').value.trim();
    const price = parseFloat(document.getElementById('manualProductPrice').value) || 0;

    if (!name || quantity < 1) return alert("Inserisci nome e quantit√† validi.");

    // Prepariamo i dati nello stesso formato di add_selected, usando il nome come barcode
    const itemsToAdd = [{
        barcode: name,  // barcode impostato al nome del prodotto
        name: name,
        quantity: quantity,
        shop: shop,
        price: price
    }];

    const response = await fetch('/shopping_list/add_selected', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: itemsToAdd })
    });

    if (response.ok) {
        const data = await response.json();
        document.getElementById('shoppingListContainer').innerHTML = data.shopping_list_html;
        document.getElementById('shopTotalsContainer').innerHTML = data.shop_totals_html;
    }

    const modal = bootstrap.Modal.getInstance(document.getElementById('manualAddModal'));
    modal.hide();
});



// --- Rimuovi selezionati ---
document.getElementById('deleteSelectedBtn').addEventListener('click', async function () {
    const checkboxes = document.querySelectorAll('.shopping-checkbox:checked');
    const selectedBarcodes = Array.from(checkboxes).map(cb => cb.value);

    if (selectedBarcodes.length === 0) return;

    const response = await fetch('/shopping_list/remove_selected', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ barcodes: selectedBarcodes })
    });

    if (response.ok) {
        const data = await response.json();
        document.getElementById('shoppingListContainer').innerHTML = data.shopping_list_html;
        document.getElementById('shopTotalsContainer').innerHTML = data.shop_totals_html;
    }
});

// --- Finalizza lista ---
document.getElementById('finalizeListBtn').addEventListener('click', async function () {
    const response = await fetch('/shopping_list/finalize', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    });

    if (response.ok) {
        alert("Lista finalizzata: l'ordinamento dei reparti verr√† calcolato in background.");
    } else {
        alert("Errore durante la finalizzazione della lista.");
    }
});
</script>

{% endblock %}
