{% extends 'layout.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">üì¶ Magazzino</h2>
  <div id="advanced-settings-messages" class="ms-3" style="min-width: 300px; display: inline-block;"></div>
</div>

<br>
<style>
  .custom-table thead {
      background-color: #0050b9 !important;
      color: white !important;
      position: sticky;
      top: 0;
      z-index: 10;
  }
  .custom-table th, .custom-table td {
      border: 2px solid #dee2e6;
      padding: 10px;
      text-align: center;
  }
  .custom-table {
    border-collapse: collapse !important;
  }
  .custom-table tbody tr:nth-child(odd) td {
      background-color: #ffffff !important;
  }
  .custom-table tbody tr:nth-child(even) td {
      background-color: #e7f1ff !important;
  }
  .table-dark {
      background-color: #0050b9 !important;
      color: white !important;
  }
  .table-container {
      max-height: 600px;
      overflow-y: auto;
      border: 2px solid #dee2e6;
      display: block;
  }
  .custom-table thead {
      position: sticky;
      top: 0;
      background-color: #0050b9;
      z-index: 10;
  }
  .table-container .row.bg-primary {
      background-color: transparent !important;
  }
  .consume-btn {
    min-width: 160px; /* Scegli la larghezza che preferisci */
  }
</style>

<!-- Modale per selezionare il lotto da consumare. Prima TAB -->
<div class="modal fade" id="consumeModal" tabindex="-1" aria-labelledby="consumeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="consumeModalLabel">Seleziona lotto da consumare</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body">
        <select id="consumeSelect" class="form-select"></select>
      </div>
      <div class="modal-footer">
        <button type="button" id="confirmConsumeBtn" class="btn btn-primary">Conferma</button>
      </div>
    </div>
  </div>
</div>

<br>
<ul class="nav nav-tabs" id="productTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="gestione-tab" data-bs-toggle="tab" data-bs-target="#gestione" type="button" role="tab" aria-controls="gestione" aria-selected="true">
      üìã Gestione Magazzino
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="list-tab" data-bs-toggle="tab" data-bs-target="#list" type="button" role="tab" aria-controls="list" aria-selected="false">
      üìã Prodotti in Magazzino
    </button>
  </li>
</ul>

<div class="tab-content mt-3">

  <!-- üìã Gestione Magazzino-->
  <div class="tab-pane fade show active" id="gestione" role="tabpanel" aria-labelledby="gestione-tab">
  <div class="table-container">
    <table class="table table-bordered custom-table" id="gestione-table">
      <thead class="table-dark">
        <tr>
          <th>Prodotto</th>
          <th>Barcode</th>
          <th>Nome</th>
          <th>Articolo</th>
          <th>Categoria</th>
          <th>Prezzo</th>
          <th>Quantit√† Attuale</th>
          <th>Valore Totale</th>
          <th>Azioni</th>
        </tr>
        <tr>
          <th></th>
          <th></th>
          <th>
            <select id="filterNameGestione" class="form-select form-select-sm">
              <option value="">Tutti</option>
            </select>
          </th>
          <th>
            <select id="filterArticleGestione" class="form-select form-select-sm">
              <option value="">Tutti</option>
            </select>
          </th>
          <th>
            <select id="filterCategoryGestione" class="form-select form-select-sm">
              <option value="">Tutte</option>
            </select>
          </th>
          <th colspan="4"></th>
        </tr>
      </thead>
      <tbody>
        {% for product in products %}
          <tr data-barcode="{{ product.barcode }}">
            <td>
              {% if product.image %}
                <img src="{{ product.image }}" alt="Immagine prodotto" style="max-width: 80px; height: auto;">
              {% else %}
                <span class="text-muted">Nessuna immagine</span>
              {% endif %}
            </td>
            <td>{{ product.barcode or "-" }}</td>
            <td>{{ product.name or "-" }}</td>
            <td>{{ product.item or "-" }}</td>
            <td>{{ product.category or "-" }}</td>
            <td>‚Ç¨{{ product.price or "0.00" }}</td>  
            <td>{{ product.quantity_in_inventory or "-" }}</td>
            <td>‚Ç¨{{ product.total_value or "0.00" }}</td>
            <td>
              <button class="btn btn-sm btn-warning consume-btn">üçΩÔ∏è Consumato</button>
            </td>

          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- üìã Prodotti in Magazzino-->
  <div class="tab-pane fade" id="list" role="tabpanel" aria-labelledby="list-tab">
    <div class="table-container">
      <table class="table table-bordered custom-table" id="list-table">
        <thead class="table-dark">
          <tr>
            <th>Prodotto</th>
            <th>Nome</th>
            <th>Categoria</th>
            <th>Prezzo</th>
            <th>Quantita` Attuale</th>
            <th>Scorta Minima</th>
            <th>Scorta Massima</th>
            <th>Scorta Sicurezza</th>
            <th>Punto di Riordino</th>
            <th>Tempo Consumo Medio</th>
            <th>Frequenza Riordino</th>
            <th>Aggiornamento Automatico</th>
            <th>Azioni</th>
          </tr>
          <tr>
            <th></th>
            <th>
              <select id="filterNameList" class="form-select form-select-sm">
                <option value="">Tutti</option>
              </select>
            </th>
            <th>
              <select id="filterCategoryList" class="form-select form-select-sm">
                <option value="">Tutte</option>
              </select>
            </th>
            <th colspan="10"></th>
          </tr>
        </thead>
        <tbody>
          {% for product in products %}
          <tr data-barcode="{{ product.barcode }}">
            <td>
              {% if product.image %}
                <img src="{{ product.image }}" alt="Immagine prodotto" style="max-width: 80px; height: auto;">
              {% else %}
                <span class="text-muted">Nessuna immagine</span>
              {% endif %}
            </td>
            <td>{{ product.name }}</td>
            <td>{{ product.category or "-" }}</td>
            <td>‚Ç¨{{ product.price or "0.00" }}</td>
            <td>{{ product.quantity_in_inventory or "-" }}</td>
            <td>
              <input type="number"  min="0" class="form-control form-control-sm inline-edit" data-field="min_quantity"
                value="{{ product.min_quantity or '' }}">
            </td>
            <td>
              <input type="number"  min="0" class="form-control form-control-sm inline-edit" data-field="max_quantity"
                value="{{ product.max_quantity or '' }}">
            </td>
            <td>
              <input type="number"  min="0" class="form-control form-control-sm inline-edit" data-field="security_quantity"
                value="{{ product.security_quantity or '' }}">
            </td>
            <td>
              <input type="number"  min="0" class="form-control form-control-sm inline-edit" data-field="reorder_point"
                value="{{ product.reorder_point or '' }}">
            </td>
            <td>
              <input type="number"  min="0" class="form-control form-control-sm inline-edit mean-usage" data-field="mean_usage_time"
                value="{{ product.mean_usage_time or '' }}">
            </td>
            <td>
              <input type="number"  min="0" class="form-control form-control-sm inline-edit reorder-freq" data-field="reorder_frequency"
                value="{{ product.reorder_frequency or '' }}">
            </td>
            <td>
              <input type="checkbox" class="form-check-input auto-update-checkbox"
                data-field="user_override"
                {% if product.user_override == 1 %}checked{% endif %}>
            </td>
            <td>
              <button class="btn btn-sm btn-success save-row-btn" style="display:none;">üíæ Salva</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

<!-- --- PRIMA TAB - INVENTORY: Filtri e bottone Consumato avanzato --- -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  function populateGestioneFilters() {
    const nameSet = new Set();
    const articleSet = new Set();
    const categorySet = new Set();
    document.querySelectorAll('#gestione-table tbody tr').forEach(row => {
      const name = row.children[2].textContent.trim();
      const article = row.children[3].textContent.trim();
      const category = row.children[4].textContent.trim();
      if (name) nameSet.add(name);
      if (article) articleSet.add(article);
      if (category) categorySet.add(category);
    });
    const filterName = document.getElementById('filterNameGestione');
    const filterArticle = document.getElementById('filterArticleGestione');
    const filterCategory = document.getElementById('filterCategoryGestione');
    filterName.innerHTML = '<option value="">Tutti</option>';
    filterArticle.innerHTML = '<option value="">Tutti</option>';
    filterCategory.innerHTML = '<option value="">Tutte</option>';
    Array.from(nameSet).sort().forEach(name => {
      filterName.innerHTML += `<option value="${name}">${name}</option>`;
    });
    Array.from(articleSet).sort().forEach(article => {
      filterArticle.innerHTML += `<option value="${article}">${article}</option>`;
    });
    Array.from(categorySet).sort().forEach(cat => {
      filterCategory.innerHTML += `<option value="${cat}">${cat}</option>`;
    });
  }

  function filterGestioneTable() {
    const nameVal = document.getElementById('filterNameGestione').value;
    const articleVal = document.getElementById('filterArticleGestione').value;
    const catVal = document.getElementById('filterCategoryGestione').value;
    document.querySelectorAll('#gestione-table tbody tr').forEach(row => {
      const name = row.children[2].textContent.trim();
      const article = row.children[3].textContent.trim();
      const category = row.children[4].textContent.trim();
      let show = true;
      if (nameVal && name !== nameVal) show = false;
      if (articleVal && article !== articleVal) show = false;
      if (catVal && category !== catVal) show = false;
      row.style.display = show ? '' : 'none';
    });
  }

  populateGestioneFilters();
  document.getElementById('filterNameGestione').addEventListener('change', filterGestioneTable);
  document.getElementById('filterArticleGestione').addEventListener('change', filterGestioneTable);
  document.getElementById('filterCategoryGestione').addEventListener('change', filterGestioneTable);

  // --- Nuovo comportamento bottone Consumato ---
  let selectedRow = null;
  let selectedBarcode = null;

  document.querySelectorAll('#gestione-table .consume-btn').forEach(function(button) {
    button.addEventListener('click', function() {
      console.log("Cliccato Consumato!");
      selectedRow = button.closest('tr');
      selectedBarcode = selectedRow.dataset.barcode;
      const productName = selectedRow.children[2].textContent.trim();

      // Fetch lotti disponibili per questo prodotto
      fetch("/products/unconsumed_dropdown")
        .then(res => res.json())
        .then(products => {
          // Filtra solo i lotti del prodotto selezionato
          const filtered = products.filter(p => p.name === productName);
          const select = document.getElementById('consumeSelect');
          select.innerHTML = '';
          if (filtered.length > 0) {
            filtered.forEach(record => {
              const label = `Inserito: ${record.ins_date} - Scadenza: ${record.expiry_date || 'N/A'} - Q.t√†: ${record.quantity}`;
              select.innerHTML += `<option value="${record.ins_date}|${record.expiry_date}|${record.id}|${record.barcode}|${record.quantity}">${label}</option>`;
            });
            const modal = new bootstrap.Modal(document.getElementById('consumeModal'));
            modal.show();
          } else {
            alert("Nessun lotto disponibile per questo prodotto.");
          }
        });
    });
  });

  document.getElementById('confirmConsumeBtn').addEventListener('click', function() {
    const select = document.getElementById('consumeSelect');
    if (!select.value) return;
    const [ins_date, expiry_date, id, product_key, quantity] = select.value.split('|');
    // Chiamata alla route per consumare il prodotto
    fetch(`/consumed_product?id=${id}&product_key=${product_key}&barcode=${encodeURIComponent(selectedBarcode)}&ins_date=${ins_date}&expiry_date=${expiry_date}&quantity=${quantity}`)
      .then(res => res.json())
      .then(data => {
        console.log('Risposta da /consumed_product:', data);
        if (data.success) {
          // Aggiorna la quantit√† nella tabella
          selectedRow.children[6].textContent = data.quantita;
          // Aggiorna il bottone
          const btn = selectedRow.querySelector('.consume-btn');
          btn.textContent = "‚úÖ DB Aggiornato";
          btn.classList.remove('btn-warning');
          btn.classList.add('btn-success');
          btn.disabled = true;
          // Chiudi il modale
          bootstrap.Modal.getInstance(document.getElementById('consumeModal')).hide();
          // Dopo 2 secondi, ripristina il bottone
          setTimeout(() => {
            btn.textContent = "üçΩÔ∏è Consumato";
            btn.classList.remove('btn-success');
            btn.classList.add('btn-warning');
            btn.disabled = false;
          }, 2000);
        } else {
          alert("Errore durante la registrazione del consumo.");
        }
      });
  });
});
</script>

<!-- --- SECONDA TAB - LIST: Filtri e inline edit --- -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  // Gestione readonly dei campi consumo medio e frequenza riordino
  document.querySelectorAll('.auto-update-checkbox').forEach(function (checkbox) {
    const row = checkbox.closest('tr');
    const meanUsage = row.querySelector('.mean-usage');
    const reorderFreq = row.querySelector('.reorder-freq');
    function toggleReadonly() {
      const checked = checkbox.checked;
      meanUsage.readOnly = checked;
      reorderFreq.readOnly = checked;
    }
    checkbox.addEventListener('change', function () {
      toggleReadonly();
      showSave(row);
    });
    toggleReadonly();
  });

  // Mostra il tasto Salva quando una cella viene modificata
  document.querySelectorAll('.inline-edit, .auto-update-checkbox').forEach(function (input) {
    input.addEventListener('input', function () {
      const row = input.closest('tr');
      showSave(row);
    });
  });

  // Gestione click sul tasto Salva
  document.querySelectorAll('.save-row-btn').forEach(function (btn) {
    btn.addEventListener('click', function () {
      const row = btn.closest('tr');
      const barcode = row.dataset.barcode;
      // Raccogli tutti i valori dei campi modificabili
      const data = {
        barcode: barcode,
        min_quantity: row.querySelector('input[data-field="min_quantity"]').value,
        max_quantity: row.querySelector('input[data-field="max_quantity"]').value,
        security_quantity: row.querySelector('input[data-field="security_quantity"]').value,
        reorder_point: row.querySelector('input[data-field="reorder_point"]').value,
        mean_usage_time: row.querySelector('input[data-field="mean_usage_time"]').value,
        reorder_frequency: row.querySelector('input[data-field="reorder_frequency"]').value,
        user_override: row.querySelector('.auto-update-checkbox').checked ? 1 : 0
      };

      // Soft check logico
      if (Number(data.min_quantity) > Number(data.max_quantity)) {
        alert("La scorta minima deve essere inferiore alla scorta massima.");
        return;
      }
      if (Number(data.security_quantity) >= Number(data.max_quantity)) {
        alert("La scorta di sicurezza deve essere inferiore alla scorta massima.");
        return;
      }
      if (Number(data.reorder_point) >= Number(data.max_quantity)) {
        alert("Il punto di riordino deve essere inferiore alla scorta massima.");
        return;
      }

      fetch('/inventory/update_inline', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(data => {
        btn.style.display = 'none';
        let icon = document.createElement('span');
        icon.style.fontSize = '1.5em';
        icon.style.marginLeft = '5px';
        if (data.success) {
          icon.textContent = 'üòä';
          icon.style.color = 'green';
        } else {
          icon.textContent = 'üòû';
          icon.style.color = 'red';
        }
        btn.parentNode.appendChild(icon);
        setTimeout(() => {
          icon.remove();
        }, 2000);
      });
    });
  });

  // Funzione per mostrare il tasto Salva
  function showSave(row) {
    const btn = row.querySelector('.save-row-btn');
    if (btn) btn.style.display = '';
  }
});
</script>

<script>
// Funzione per popolare i filtri dinamici TAB1  
document.addEventListener("DOMContentLoaded", function () {
  // ... (script inline editing gi√† presente) ...

  // --- FILTRI DINAMICI ---
  function populateFilters() {
    const nameSet = new Set();
    const categorySet = new Set();
    document.querySelectorAll('tbody tr').forEach(row => {
      const name = row.children[1].textContent.trim();
      const category = row.children[2].textContent.trim();
      if (name) nameSet.add(name);
      if (category) categorySet.add(category);
    });

    const filterName = document.getElementById('filterName');
    const filterCategory = document.getElementById('filterCategory');
    // Pulisci le opzioni tranne la prima
    filterName.innerHTML = '<option value="">Tutti</option>';
    filterCategory.innerHTML = '<option value="">Tutte</option>';

    Array.from(nameSet).sort().forEach(name => {
      filterName.innerHTML += `<option value="${name}">${name}</option>`;
    });
    Array.from(categorySet).sort().forEach(cat => {
      filterCategory.innerHTML += `<option value="${cat}">${cat}</option>`;
    });
  }

  function filterTable() {
    const nameVal = document.getElementById('filterName').value;
    const catVal = document.getElementById('filterCategory').value;
    document.querySelectorAll('tbody tr').forEach(row => {
      const name = row.children[1].textContent.trim();
      const category = row.children[2].textContent.trim();
      let show = true;
      if (nameVal && name !== nameVal) show = false;
      if (catVal && category !== catVal) show = false;
      row.style.display = show ? '' : 'none';
    });
  }

  populateFilters();

  document.getElementById('filterName').addEventListener('change', filterTable);
  document.getElementById('filterCategory').addEventListener('change', filterTable);
});
</script>

{% endblock %}