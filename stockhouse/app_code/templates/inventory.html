{% extends 'layout.html' %}

{% block content %}
<h2 class="mb-4">üì¶ Magazzino</h2>

<!-- ‚úÖ Stile per tabella con righe alternate -->
<style>
    /* Intestazione tabella */
    thead th {
      background-color: #0050b9 !important;
      color: white !important;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    /* Alternanza righe */
    table.custom-table tbody tr:nth-child(odd) td {
      background-color: #ffffff !important;
    }

    table.custom-table tbody tr:nth-child(even) td {
      background-color: #e7f1ff !important;
    }

    /* Rende i bordi della tabella grigio chiaro */
    .table-bordered td,
    .table-bordered th {
      border: 1px solid #dee2e6; /* colore grigio chiaro (come Bootstrap usa di default) */
    }

    table.custom-table tr:hover td.shop-id {
      color: #555;
    }

    /* Scroll per il corpo della tabella */
    .table-container {
      max-height: 600px; /* Altezza massima della tabella */
      overflow-y: auto;
      border: 1px solid #dee2e6;
    }
</style>

<br>  
<!-- Nav tabs -->
<ul class="nav nav-tabs" id="productTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list" type="button" role="tab" aria-controls="list" aria-selected="true">
      üìã Prodotti in Magazzino
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="add-tab" data-bs-toggle="tab" data-bs-target="#add" type="button" role="tab" aria-controls="add" aria-selected="false">
      ‚öôÔ∏è Impostazioni avanzate ottimizzazione spesa
    </button>
  </li>
</ul>

<!-- Tab content -->
<div class="tab-content mt-3">

  <!-- üìã Lista tab -->
  <div class="tab-pane fade show active" id="list" role="tabpanel" aria-labelledby="list-tab">
    <div class="table-container">
      <table class="table table-bordered custom-table">
        <thead class="table-dark">
          <tr>
            <th title="Immagine del prodotto">Prodotto</th>
            <th title="Nome del prodotto">Nome</th>
            <th title="Categoria del prodotto">Categoria</th>
            <th title="Prezzo per unit√† del prodotto">Prezzo</th>
            <th title="Quantit√† attuale in magazzino">Quantita` Attuale</th>
            <th title="Quantit√† minima per il prodotto">Scorta Minima</th>
            <th title="Quantit√† massima per il prodotto">Scorta Massima</th>
            <th title="Quantit√† di sicurezza per evitare rotture di stock">Scorta Sicurezza</th>
            <th title="Punto in cui bisogna riordinare il prodotto">Punto di Riordino</th>
            <th title="Tempo medio di consumo del prodotto (giorni)">Tempo Consumo Medio</th>
            <th title="Frequenza con cui riordinare il prodotto (giorni)">Frequenza Riordino</th>
            <th title="Parametri aggiornati automaticamente">Aggiornamento Automatico</th>
            <th title="Azioni che puoi eseguire sul prodotto">Azioni</th>
          </tr>
        </thead>
        <tbody>
          {% for product in products %}
          <tr>
            <td>
              {% if product.image %}
                <img src="{{ product.image }}" alt="Immagine prodotto" style="max-width: 80px; height: auto;">
              {% else %}
                <span class="text-muted">Nessuna immagine</span>
              {% endif %}
            </td>
            <td>{{ product.name }}</td>
            <td>{{ product.category or "-" }}</td>
            <td>‚Ç¨{{ product.price or "0.00" }}</td>
            <td>{{ product.quantity_in_inventory or "-" }}</td>
            <td>{{ product.min_quantity or "-" }}</td>
            <td>{{ product.max_quantity or "-" }}</td>
            <td>{{ product.security_quantity or "-" }}</td>
            <td>{{ product.reorder_point or "-" }}</td>
            <td>{{ product.mean_usage_time or "-" }}</td>
            <td>{{ product.reorder_frequency or "-" }}</td>
            <td>{{ 'S√¨' if product.user_override == 1 else 'No' }}</td>
            <td>
              <a href="{{ url_for('main.edit_inventory', barcode=product.barcode) }}" class="btn btn-sm btn-warning">‚úèÔ∏è Modifica</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- ‚ûï Aggiungi prodotto -->
  <div class="tab-pane fade" id="add" role="tabpanel" aria-labelledby="add-tab">
      <div class="row">
        <div class="col-md-7">
          <form method="POST" class="text-start" id="product-form">
              <br> <!-- Aggiungi qui linee vuote -->

              <!-- Barcode -->
              <div class="row mb-2 align-items-center">
                  <div class="col-2">
                    <label for="barcode" class="form-label mb-0" style="color: #00008B" >Barcode</label>
                  </div>
                  <div class="col-5">
                    <input type="text" class="form-control form-control-sm" id="barcode" name="barcode" required maxlength="25" style="background-color:  #e6f2ff;" onchange="autoFillProduct()" onblur="autoFillProduct()">   
                  </div>
              </div>

              <!-- Nome -->
              <div class="row mb-2 align-items-center">
                <div class="col-2">
                  <label for="name" class="form-label mb-0" style="color: #00008B" >Nome</label>
                </div>
                <div class="col-5">
                  <input type="text" class="form-control form-control-sm" id="name" name="name" required maxlength="25" style="background-color:  #e6f2ff;">
                </div>
              </div>
          
              <!-- Marca -->
              <div class="row mb-2 align-items-center">
                <div class="col-2">
                  <label for="brand" class="form-label mb-0" style="color: #00008B" >Marca</label>
                </div>
                <div class="col-5">
                  <input type="text" class="form-control form-control-sm" id="brand" name="brand" required maxlength="25" style="background-color:  #e6f2ff;">
                </div>
              </div>
          
              <!-- Negozio -->
              <div class="row mb-2 align-items-center">
                <div class="col-2">
                  <label for="shop" class="form-label mb-0" style="color: #00008B" >Negozio</label>
                </div>
                <div class="col-5">
                  <select class="form-select form-select-sm" id="shop" name="shop" required style="background-color:  #e6f2ff;">
                    <option value="">Seleziona un negozio</option>
                    {% for shop in shop_list %}
                      <option value="{{ shop[1] }}">{{ shop[1] }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
          
              <!-- Prezzo -->
              <div class="row mb-2 align-items-center">
                <div class="col-2">
                  <label for="price" class="form-label mb-0" style="color: #00008B" >Prezzo</label>
                </div>
                <div class="col-5">
                  <input type="number" step="0.01" class="form-control form-control-sm" id="price" name="price" required style="background-color:  #e6f2ff;">
                </div>
              </div>
          
              <!-- Quantit√† Minima in dispensa-->
              <div class="row mb-2 align-items-center">
                <div class="col-2">
                  <label for="quantity" class="form-label mb-0" style="color: #00008B" >Min Dispensa</label>
                </div>
                <div class="col-5">
                  <input type="number" min="1" class="form-control form-control-sm" id="quantity" name="quantity" required style="background-color:  #e6f2ff;">
                </div>
              </div>

    
              <!-- Categoria -->
              <div class="row mb-2 align-items-center">
                <div class="col-2">
                  <label for="category" class="form-label mb-0" style="color: #00008B" >Categoria</label>
                </div>
                <div class="col-5">
                  <select class="form-select form-select-sm" id="category" name="category" required style="background-color:  #e6f2ff;">
                    <option value="">Seleziona una categoria</option>
                    {% for cat in categories %}
                      <option value="{{ cat[1] }}">{{ cat[1] }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
          
              <!-- Scadenza -->
              <div class="row mb-2 align-items-center">
                <div class="col-2">
                  <label for="expiry_date" class="form-label mb-0" style="color: #00008B" >Scadenza</label>
                </div>
                <div class="col-5">
                  <input type="date" class="form-control form-control-sm" id="expiry_date" name="expiry_date" style="background-color:  #e6f2ff;">
                </div>
              </div>

              <!-- Submit -->
              <button type="submit" class="btn btn-primary mt-2">Aggiungi Prodotto</button>

          </form>
        </div>
        
        <div class="product-image-frame">
          <img id="productImage" src="" alt="Immagine prodotto" style="display: none; max-width: 100%;">
          <p id="image-placeholder" class="text-muted">üîç Inserisci un barcode per vedere l'immagine.</p>
        </div>

      </div>
    
    </div>
</div>

<script>
  function autoFillProduct() {
    const value = document.getElementById('barcode').value.trim();
  
    if (!value) return;
  
    // Se contiene solo cifre ‚Üí √® barcode, altrimenti √® nome
    const isBarcode = /^\d+$/.test(value);
  
    const url = isBarcode
      ? `/api/product-by-barcode?barcode=${encodeURIComponent(value)}`
      : `/api/product-by-name?name=${encodeURIComponent(value)}`;
  
    fetch(url)
      .then(response => response.json())
      .then(data => {
        if (data && data.found) {
          document.getElementById('name').value = data.name || '';
          document.getElementById('brand').value = data.brand || '';
          document.getElementById('shop').value = data.shop || '';
          document.getElementById('price').value = data.price || '';
          document.getElementById('category').value = data.category || '';
          document.getElementById('expiry_date').value = data.expiry_date || '';
          document.getElementById('quantity').value = data.quantity || '';
  
          if (data.image) {
            document.getElementById('productImage').src = data.image;
            document.getElementById('productImage').style.display = 'block';
            document.getElementById('image-placeholder').style.display = 'none';
          }
        } else {
          console.log("Nessun prodotto trovato");
        }
      })
      .catch(err => {
        console.error("Errore nella richiesta:", err);
      });
  }
  </script>
    
  
{% endblock %}