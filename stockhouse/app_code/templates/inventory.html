{% extends 'layout.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">üì¶ Magazzino</h2>
  <div id="advanced-settings-messages" class="ms-3" style="min-width: 300px; display: inline-block;"></div>
</div>

<br>
<!-- ‚úÖ Stile migliorato per tabella con righe alternate, bordi definiti e header fisso -->
<style>
  /* Intestazione tabella */
  .custom-table thead {
      background-color: #0050b9 !important; /* Blu uniforme */
      color: white !important;
      position: sticky;
      top: 0;
      z-index: 10;
  }

  /* Definizione dei bordi su righe E colonne */
  .custom-table th, .custom-table td {
      border: 2px solid #dee2e6; /* Bordo visibile */
      padding: 10px;
      text-align: center;
  }

  .custom-table {
    border-collapse: collapse !important;
  }
  
  /* Alternanza righe */
  .custom-table tbody tr:nth-child(odd) td {
      background-color: #ffffff !important;
  }

  .custom-table tbody tr:nth-child(even) td {
      background-color: #e7f1ff !important;
  }

  /* Rende l'header uniforme con la fascia blu */
  .table-dark {
      background-color: #0050b9 !important; 
      color: white !important;
  }

  /* Scroll per il corpo della tabella */
  .table-container {
      max-height: 600px; /* Altezza massima */
      overflow-y: auto;
      border: 2px solid #dee2e6;
      display: block;
  }

  /* Mantiene l'header fisso durante lo scroll */
  .custom-table thead {
      position: sticky;
      top: 0;
      background-color: #0050b9;
      z-index: 10;
  }

  /* Evita sovrapposizione tra intestazione e contenuto */
  .table-container .row.bg-primary {
      background-color: transparent !important;
  }

</style>


<br>  
<!-- Nav tabs -->
<ul class="nav nav-tabs" id="productTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list" type="button" role="tab" aria-controls="list" aria-selected="true">
      üìã Prodotti in Magazzino
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="add-tab" data-bs-toggle="tab" data-bs-target="#add" type="button" role="tab" aria-controls="add" aria-selected="false">
      ‚öôÔ∏è Impostazioni avanzate ottimizzazione spesa
    </button>
  </li>
</ul>



<!-- Tab content  -->
<div class="tab-content mt-3">

  <!-- üìã Prodotti in Magazzino-->
  <div class="tab-pane fade show active" id="list" role="tabpanel" aria-labelledby="list-tab">
    <div class="table-container">
      <table class="table table-bordered custom-table">
        <thead class="table-dark">
          <tr>
            <th title="Immagine del prodotto">Prodotto</th>
            <th title="Nome del prodotto">Nome</th>
            <th title="Categoria del prodotto">Categoria</th>
            <th title="Prezzo per unit√† del prodotto">Prezzo</th>
            <th title="Quantit√† attuale in magazzino">Quantita` Attuale</th>
            <th title="Quantit√† minima per il prodotto">Scorta Minima</th>
            <th title="Quantit√† massima per il prodotto">Scorta Massima</th>
            <th title="Quantit√† di sicurezza per evitare rotture di stock">Scorta Sicurezza</th>
            <th title="Punto in cui bisogna riordinare il prodotto">Punto di Riordino</th>
            <th title="Tempo medio di consumo del prodotto (giorni)">Tempo Consumo Medio</th>
            <th title="Frequenza con cui riordinare il prodotto (giorni)">Frequenza Riordino</th>
            <th title="Parametri aggiornati automaticamente">Aggiornamento Automatico</th>
            <th title="Azioni che puoi eseguire sul prodotto">Azioni</th>
          </tr>
        </thead>
        <tbody>
          {% for product in products %}
          <tr>
            <td>
              {% if product.image %}
                <img src="{{ product.image }}" alt="Immagine prodotto" style="max-width: 80px; height: auto;">
              {% else %}
                <span class="text-muted">Nessuna immagine</span>
              {% endif %}
            </td>
            <td>{{ product.name }}</td>
            <td>{{ product.category or "-" }}</td>
            <td>‚Ç¨{{ product.price or "0.00" }}</td>
            <td>{{ product.quantity_in_inventory or "-" }}</td>
            <td>{{ product.min_quantity or "-" }}</td>
            <td>{{ product.max_quantity or "-" }}</td>
            <td>{{ product.security_quantity or "-" }}</td>
            <td>{{ product.reorder_point or "-" }}</td>
            <td>{{ product.mean_usage_time or "-" }}</td>
            <td>{{ product.reorder_frequency or "-" }}</td>
            <td>{{ 'S√¨' if product.user_override == 1 else 'No' }}</td>
            <td>
              <a href="{{ url_for('main.edit_inventory', barcode=product.barcode) }}" class="btn btn-sm btn-warning">‚úèÔ∏è Modifica</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- ‚öôÔ∏è Impostazioni avanzate ottimizzazione spesa -->
  <div class="tab-pane fade" id="add" role="tabpanel" aria-labelledby="add-tab">
    <div id="inventory-container"> 
     <div class="table-container">
      
      <table class="table table-bordered custom-table" id="advanced-table">
        <thead class="table-dark">
          <tr>
            <th>Prodotto</th>
            <th>Barcode</th>
            <th>Nome</th>
            <th>
              <label for="filterTipoProdotto">Tipo:</label>
              <select id="filterTipoProdotto">
                <option value="">Mostra Tutti</option>
                <option value="Indispensabile">Indispensabile</option>
                <option value="Utile">Utile</option>
                <option value="Occasionale">Occasionale</option>
                <option value="Stagionale">Stagionale</option>
              </select>
            </th>
            <th>
              <label for="filterStagione">Stagione:</label>
              <select id="filterStagione">
                <option value="">Mostra Tutti</option>
                <option value="Primavera">Primavera</option>
                <option value="Estate">Estate</option>
                <option value="Autunno">Autunno</option>
                <option value="Inverno">Inverno</option>
                <option value="Tutte">Tutte</option>
              </select>
            </th>
            <th>Priorit√†</th>
            <th>Azioni</th>
          </tr>
        </thead>
            <tbody>
              <tr>
                <td>
                  <select class="tipo-prodotto">
                    <option value="Indispensabile">Indispensabile</option>
                    <option value="Utile">Utile</option>
                    <option value="Occasionale">Occasionale</option>
                    <option value="Stagionale">Stagionale</option>
                  </select>
                </td>
                <td>
                  <select class="tipo-prodotto">
                    <option value="Indispensabile">Indispensabile</option>
                    <option value="Utile">Utile</option>
                    <option value="Occasionale">Occasionale</option>
                    <option value="Stagionale">Stagionale</option>
                  </select>
                </td>

                <td>‚úèÔ∏è Modifica</td>
              </tr>
              <!-- Altre righe generate da JS -->

                      <!-- Sar√† riempito da JavaScript -->

            </tbody>
          </table>
        </div>
     </div>   
  </div>

</div>

<script>
  function autoFillProduct() {
    const value = document.getElementById('barcode').value.trim();
    if (!value) return;
    const isBarcode = /^\d+$/.test(value);
    const url = isBarcode
      ? `/api/product-by-barcode?barcode=${encodeURIComponent(value)}`
      : `/api/product-by-name?name=${encodeURIComponent(value)}`;
  
    fetch(url)
      .then(response => response.json())
      .then(data => {
        if (data && data.found) {
          document.getElementById('name').value = data.name || '';
          document.getElementById('brand').value = data.brand || '';
          document.getElementById('shop').value = data.shop || '';
          document.getElementById('price').value = data.price || '';
          document.getElementById('category').value = data.category || '';
          document.getElementById('expiry_date').value = data.expiry_date || '';
          document.getElementById('quantity').value = data.quantity || '';
          if (data.image) {
            document.getElementById('productImage').src = data.image;
            document.getElementById('productImage').style.display = 'block';
            document.getElementById('image-placeholder').style.display = 'none';
          }
        } else {
          console.log("Nessun prodotto trovato");
        }
      })
      .catch(err => console.error("Errore nella richiesta:", err));
  }
</script>

<script>
  function setupAdvancedFilters() {
    const tipoSelect = document.getElementById("filterTipoProdotto");
    const stagioneSelect = document.getElementById("filterStagione");

    if (tipoSelect) {
      tipoSelect.addEventListener("change", function () {
        let filtro = this.value.toLowerCase();
        document.querySelectorAll("#advanced-table tbody tr").forEach(riga => {
          let tipo = riga.querySelector("td:nth-child(4) select");
          if (tipo) {
            let valore = tipo.value.toLowerCase();
            riga.style.display = (filtro === "" || valore === filtro) ? "" : "none";
          }
        });
      });
    }

    if (stagioneSelect) {
      stagioneSelect.addEventListener("change", function () {
        let filtro = this.value.toLowerCase();
        document.querySelectorAll("#advanced-table tbody tr").forEach(riga => {
          let stagione = riga.querySelector("td:nth-child(5) select");
          if (stagione) {
            let valore = stagione.value.toLowerCase();
            riga.style.display = (filtro === "" || valore === filtro) ? "" : "none";
          }
        });
      });
    }
  }
</script>

<script>
  function fetchAdvancedTable() {
    fetch("/products/advanced")
      .then(res => res.json())
      .then(data => {
        const tbody = document.querySelector("#advanced-table tbody");
        if (!tbody) {
          console.error("‚ùå #advanced-table tbody non trovato!");
          return;
        }
        tbody.innerHTML = "";
        console.log("üì¶ Dati ricevuti:", data.products);

        if (data.found && Array.isArray(data.products)) {
          data.products.forEach(product => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${product.image ? `<img src="${product.image}" alt="img" style="max-width: 60px;">` : '<span class="text-muted">Nessuna immagine</span>'}</td>
              <td>${product.barcode || "-"}</td>
              <td>${product.name || "-"}</td>
              <td>
                <select class="tipo-prodotto">
                  <option value="" ${!product.product_type ? "selected" : ""} disabled>-- Seleziona --</option>
                  <option value="Indispensabile" ${product.product_type === "Indispensabile" ? "selected" : ""}>Indispensabile</option>
                  <option value="Utile" ${product.product_type === "Utile" ? "selected" : ""}>Utile</option>
                  <option value="Occasionale" ${product.product_type === "Occasionale" ? "selected" : ""}>Occasionale</option>
                  <option value="Stagionale" ${product.product_type === "Stagionale" ? "selected" : ""}>Stagionale</option>
                </select>
              </td>
              <td>
                <select class="stagione">
                  <option value="" ${!product.seasons ? "selected" : ""} disabled>-- Seleziona --</option>
                  <option value="Primavera" ${product.seasons === "Primavera" ? "selected" : ""}>Primavera</option>
                  <option value="Estate" ${product.seasons === "Estate" ? "selected" : ""}>Estate</option>
                  <option value="Autunno" ${product.seasons === "Autunno" ? "selected" : ""}>Autunno</option>
                  <option value="Inverno" ${product.seasons === "Inverno" ? "selected" : ""}>Inverno</option>
                  <option value="Tutte" ${product.seasons === "Tutte" ? "selected" : ""}>Tutte</option>
                </select>
              </td>
              <td>${product.priority_level || "-"}</td>
              <td>
                <button class="btn btn-sm btn-warning update-btn" data-barcode="${product.barcode}">‚úèÔ∏è Modifica</button>
              </td>
            `;
            tbody.appendChild(row);
          });

          bindUpdateButtons();
          setupAdvancedFilters(); // üîÅ Ricollega i filtri
        } else {
          tbody.innerHTML = "<tr><td colspan='7'>Nessun prodotto avanzato trovato.</td></tr>";
        }
      })
      .catch(err => console.error("üö® Errore nel fetch:", err));
  }

  function bindUpdateButtons() {
    document.querySelectorAll(".update-btn").forEach(button => {
      button.addEventListener("click", function () {
        const row = this.closest("tr");
        const barcode = this.dataset.barcode;
        const product_type = row.querySelector(".tipo-prodotto").value;
        const seasons = row.querySelector(".stagione").value;

        console.log("üì§ Aggiorno:", barcode, product_type, seasons);

        fetch("/inventory/advanced/update", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ barcode, product_type, seasons })
        })
          .then(response => response.text())
          .then(html => {
            const container = document.querySelector("#inventory-container");
            if (container) {
              container.innerHTML = html;

              const tab = new bootstrap.Tab(document.querySelector('#add-tab'));
              tab.show();

              fetchAdvancedTable(); // Ricarica tabella aggiornata
              const successMessage = document.createElement('div');
              successMessage.className = 'alert alert-success';
              successMessage.innerHTML = 'Prodotto aggiornato con successo!';
              document.querySelector('#add-tab').prepend(successMessage);
              setTimeout(() => successMessage.remove(), 3000);
            } else {
              location.reload();
            }
            alert("‚úÖ Aggiornamento riuscito!");
          })
          .catch(error => {
            console.error("‚ùå Errore:", error);
            alert("Errore durante l'aggiornamento.");
          });
      });
    });
  }
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const advancedTabButton = document.querySelector('#add-tab');
    if (advancedTabButton) {
      advancedTabButton.addEventListener('shown.bs.tab', function () {
        fetchAdvancedTable(); // Carica dati al cambio tab
      });
    }
    setupAdvancedFilters(); // Inizializza i filtri al primo caricamento
  });
</script>


<script>
  function setupAdvancedFilters() {
    const tipoSelect = document.getElementById("filterTipoProdotto");
    const stagioneSelect = document.getElementById("filterStagione");

    if (tipoSelect) {
      tipoSelect.addEventListener("change", function () {
        let filtro = this.value.toLowerCase();
        document.querySelectorAll("#advanced-table tbody tr").forEach(riga => {
          let tipo = riga.querySelector("td:nth-child(4) select");
          if (tipo) {
            let valore = tipo.value.toLowerCase();
            riga.style.display = (filtro === "" || valore === filtro) ? "" : "none";
          }
        });
      });
    }

    if (stagioneSelect) {
      stagioneSelect.addEventListener("change", function () {
        let filtro = this.value.toLowerCase();
        document.querySelectorAll("#advanced-table tbody tr").forEach(riga => {
          let stagione = riga.querySelector("td:nth-child(5) select");
          if (stagione) {
            let valore = stagione.value.toLowerCase();
            riga.style.display = (filtro === "" || valore === filtro) ? "" : "none";
          }
        });
      });
    }
  }
</script>

<script>
  function fetchAdvancedTable() {
    fetch("/products/advanced")
      .then(res => res.json())
      .then(data => {
        const tbody = document.querySelector("#advanced-table tbody");
        if (!tbody) {
          console.error("‚ùå #advanced-table tbody non trovato!");
          return;
        }
        tbody.innerHTML = "";
        console.log("üì¶ Dati ricevuti:", data.products);

        if (data.found && Array.isArray(data.products)) {
          data.products.forEach(product => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${product.image ? `<img src="${product.image}" alt="img" style="max-width: 60px;">` : '<span class="text-muted">Nessuna immagine</span>'}</td>
              <td>${product.barcode || "-"}</td>
              <td>${product.name || "-"}</td>
              <td>
                <select class="tipo-prodotto">
                  <option value="" ${!product.product_type ? "selected" : ""} disabled>-- Seleziona --</option>
                  <option value="Indispensabile" ${product.product_type === "Indispensabile" ? "selected" : ""}>Indispensabile</option>
                  <option value="Utile" ${product.product_type === "Utile" ? "selected" : ""}>Utile</option>
                  <option value="Occasionale" ${product.product_type === "Occasionale" ? "selected" : ""}>Occasionale</option>
                  <option value="Stagionale" ${product.product_type === "Stagionale" ? "selected" : ""}>Stagionale</option>
                </select>
              </td>
              <td>
                <select class="stagione">
                  <option value="" ${!product.seasons ? "selected" : ""} disabled>-- Seleziona --</option>
                  <option value="Primavera" ${product.seasons === "Primavera" ? "selected" : ""}>Primavera</option>
                  <option value="Estate" ${product.seasons === "Estate" ? "selected" : ""}>Estate</option>
                  <option value="Autunno" ${product.seasons === "Autunno" ? "selected" : ""}>Autunno</option>
                  <option value="Inverno" ${product.seasons === "Inverno" ? "selected" : ""}>Inverno</option>
                  <option value="Tutte" ${product.seasons === "Tutte" ? "selected" : ""}>Tutte</option>
                </select>
              </td>
              <td>${product.priority_level || "-"}</td>
              <td>
                <button class="btn btn-sm btn-warning update-btn" data-barcode="${product.barcode}">‚úèÔ∏è Modifica</button>
              </td>
            `;
            tbody.appendChild(row);
          });

          bindUpdateButtons();
          setupAdvancedFilters(); // üîÅ Riapplica i filtri
        } else {
          tbody.innerHTML = "<tr><td colspan='7'>Nessun prodotto avanzato trovato.</td></tr>";
        }
      })
      .catch(err => console.error("üö® Errore nel fetch:", err));
  }

  function bindUpdateButtons() {
    document.querySelectorAll(".update-btn").forEach(button => {
      button.addEventListener("click", function () {
        const row = this.closest("tr");
        const barcode = this.dataset.barcode;
        const product_type = row.querySelector(".tipo-prodotto").value;
        const seasons = row.querySelector(".stagione").value;

        console.log("üì§ Aggiorno:", barcode, product_type, seasons);

        fetch("/inventory/advanced/update", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-Requested-With": "XMLHttpRequest"
          },
          body: new URLSearchParams({ barcode, product_type, seasons })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const successMessage = document.createElement('div');
            successMessage.className = 'alert alert-success mt-2';
            successMessage.innerText = '‚úÖ Prodotto aggiornato con successo!';
            document.querySelector('#inventory-container').prepend(successMessage);
            setTimeout(() => successMessage.remove(), 3000);

            fetchAdvancedTable(); // üîÅ Ricarica i dati aggiornati
          } else {
            alert("‚ùå Errore nell'aggiornamento del prodotto.");
          }
        })
        .catch(error => {
          console.error("‚ùå Errore:", error);
          alert("Errore durante l'aggiornamento.");
        });
      });
    });
  }

  // ‚úÖ Esegui fetch iniziale
  fetchAdvancedTable();
</script>



<script>
  document.addEventListener("DOMContentLoaded", function () {
    const advancedTabButton = document.querySelector('#add-tab');
    if (advancedTabButton) {
      advancedTabButton.addEventListener('shown.bs.tab', function () {
        fetchAdvancedTable(); // Carica dati al cambio tab
      });
    }
    setupAdvancedFilters(); // Inizializza i filtri al primo caricamento
  });
</script>


{% endblock %}