{% extends 'layout.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">üì¶ Magazzino</h2>
  <div id="advanced-settings-messages" class="ms-3" style="min-width: 300px; display: inline-block;"></div>
</div>

<br>
<style>
  .custom-table thead {
      background-color: #0050b9 !important;
      color: white !important;
      position: sticky;
      top: 0;
      z-index: 10;
  }
  .custom-table th, .custom-table td {
      border: 2px solid #dee2e6;
      padding: 10px;
      text-align: center;
  }
  .custom-table {
    border-collapse: collapse !important;
  }
  .custom-table tbody tr:nth-child(odd) td {
      background-color: #ffffff !important;
  }
  .custom-table tbody tr:nth-child(even) td {
      background-color: #e7f1ff !important;
  }
  .table-dark {
      background-color: #0050b9 !important;
      color: white !important;
  }
  .table-container {
      max-height: 600px;
      overflow-y: auto;
      border: 2px solid #dee2e6;
      display: block;
  }
  /* Tasto consumato compatto */
  .consume-btn-small {
    padding: 2px 8px;
    font-size: 1.1rem;
  }
  /* Stile mini tabella HA */
  .ha-card {
    border: 2px solid #0050b9;
  }
  .ha-header {
    background-color: #0050b9 !important;
    color: white;
    font-weight: bold;
  }
</style>

<div class="modal fade" id="consumeModal" tabindex="-1" aria-labelledby="consumeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="consumeModalLabel">Seleziona lotto da consumare</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body">
        <select id="consumeSelect" class="form-select"></select>
      </div>
      <div class="modal-footer">
        <button type="button" id="confirmConsumeBtn" class="btn btn-primary">Conferma</button>
      </div>
    </div>
  </div>
</div>

<div class="tab-content mt-3">

  <div class="tab-pane fade show active" id="gestione" role="tabpanel" aria-labelledby="gestione-tab">
    <div class="container-fluid px-0">
      <div class="row">
        
        <div class="col-md-9">
          <div class="table-container">
            <table class="table table-bordered custom-table" id="gestione-table">
              <thead class="table-dark">
                <tr>
                  <th>Prodotto</th>
                  <th>Barcode</th>
                  <th>Nome</th>
                  <th>Articolo</th>
                  <th>Categoria</th>
                  <th>Quantit√† Attuale</th>
                  <th>Azioni</th>
                </tr>
                <tr>
                  <th></th>
                  <th></th>
                  <th>
                    <select id="filterNameGestione" class="form-select form-select-sm"><option value="">Tutti</option></select>
                  </th>
                  <th>
                    <select id="filterArticleGestione" class="form-select form-select-sm"><option value="">Tutti</option></select>
                  </th>
                  <th>
                    <select id="filterCategoryGestione" class="form-select form-select-sm"><option value="">Tutte</option></select>
                  </th>
                  <th colspan="2"></th>
                </tr>
              </thead>
              <tbody>
                {% for product in products %}
                <tr data-barcode="{{ product.barcode }}">
                  <td>
                    {% if product.image %}
                      <img src="{{ product.image }}" alt="Immagine prodotto" style="max-width: 80px; height: auto;">
                    {% else %}
                      <span class="text-muted">Nessuna immagine</span>
                    {% endif %}
                  </td>
                  <td>{{ product.barcode or "-" }}</td>
                  <td>{{ product.name or "-" }}</td>
                  <td>{{ product.item or "-" }}</td>
                  <td>{{ product.category or "-" }}</td>
                  <td>{{ product.quantity_in_inventory or "-" }}</td>
                  <td>
                    <button class="btn btn-warning btn-sm consume-btn-small consume-btn" title="Consumato">üçΩÔ∏è</button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card ha-card shadow-sm">
            <div class="card-header ha-header text-center py-2">
               <span class="fs-5">üé§ Da Scalare</span>
            </div>
            <div class="card-body p-0">
              <div style="max-height: 560px; overflow-y: auto;">
                <table class="table table-sm table-striped mb-0">
                  <thead class="table-light">
                    <tr>
                      <th class="ps-3">Prodotto</th>
                      <th class="text-center">X</th>
                    </tr>
                  </thead>
                  <tbody id="consumati-ha-body">
                    {% if consumati_ha %}
                      {% for item in consumati_ha %}
                      <tr>
                        <td class="ps-3 align-middle text-start" style="font-size: 0.9rem;">
                          {{ item.nome }}
                        </td>
                        <td class="text-center">
                          <button class="btn btn-outline-danger btn-sm" 
                                  onclick="rimuoviDaHA('{{ item.originale }}')">X</button>
                        </td>
                      </tr>
                      {% endfor %}
                    {% else %}
                      <tr>
                        <td colspan="2" class="text-center text-muted py-3 small">Nessun prodotto da scalare</td>
                      </tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

      </div> </div> </div>

  <div class="tab-pane fade" id="pharmacy" role="tabpanel">
    <div class="container mt-4">
      <h5>ü©π Primo soccorso</h5>
      <p>Questa sezione √® dedicata ai prodotti farmaceutici e sar√† sviluppata in seguito.</p>
    </div>
  </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // --- FILTRI E CONSUMO (Indici aggiornati: Nome=2, Articolo=3, Categoria=4, Quantit√†=5) ---
  function populateGestioneFilters() {
    const nameSet = new Set(), articleSet = new Set(), categorySet = new Set();
    document.querySelectorAll('#gestione-table tbody tr').forEach(row => {
      if(row.children[2].textContent) nameSet.add(row.children[2].textContent.trim());
      if(row.children[3].textContent) articleSet.add(row.children[3].textContent.trim());
      if(row.children[4].textContent) categorySet.add(row.children[4].textContent.trim());
    });
    const filterName = document.getElementById('filterNameGestione');
    const filterArticle = document.getElementById('filterArticleGestione');
    const filterCategory = document.getElementById('filterCategoryGestione');
    filterName.innerHTML = '<option value="">Tutti</option>';
    filterArticle.innerHTML = '<option value="">Tutti</option>';
    filterCategory.innerHTML = '<option value="">Tutte</option>';
    Array.from(nameSet).sort().forEach(n=>filterName.innerHTML+=`<option value="${n}">${n}</option>`);
    Array.from(articleSet).sort().forEach(a=>filterArticle.innerHTML+=`<option value="${a}">${a}</option>`);
    Array.from(categorySet).sort().forEach(c=>filterCategory.innerHTML+=`<option value="${c}">${c}</option>`);
  }

  function filterGestioneTable() {
    const nameVal = document.getElementById('filterNameGestione').value;
    const articleVal = document.getElementById('filterArticleGestione').value;
    const catVal = document.getElementById('filterCategoryGestione').value;
    document.querySelectorAll('#gestione-table tbody tr').forEach(row => {
      const show = (!nameVal || row.children[2].textContent.trim()===nameVal)
                && (!articleVal || row.children[3].textContent.trim()===articleVal)
                && (!catVal || row.children[4].textContent.trim()===catVal);
      row.style.display = show ? '' : 'none';
    });
  }

  populateGestioneFilters();
  document.getElementById('filterNameGestione').addEventListener('change', filterGestioneTable);
  document.getElementById('filterArticleGestione').addEventListener('change', filterGestioneTable);
  document.getElementById('filterCategoryGestione').addEventListener('change', filterGestioneTable);

  // --- Bottone Consumato ---
  let selectedRow=null, selectedBarcode=null;
  document.querySelectorAll('#gestione-table .consume-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      selectedRow = btn.closest('tr');
      selectedBarcode = selectedRow.dataset.barcode;
      const productName = selectedRow.children[2].textContent.trim();
      fetch("/products/unconsumed_dropdown").then(res=>res.json()).then(products=>{
        const filtered = products.filter(p=>p.name===productName);
        const select = document.getElementById('consumeSelect');
        select.innerHTML='';
        if(filtered.length>0){
          filtered.forEach(record=>{
            select.innerHTML += `<option value="${record.ins_date}|${record.expiry_date}|${record.id}|${record.barcode}|${record.quantity}">Inserito: ${record.ins_date} - Scadenza: ${record.expiry_date||'N/A'} - Q.t√†: ${record.quantity}</option>`;
          });
          new bootstrap.Modal(document.getElementById('consumeModal')).show();
        } else alert("Nessun lotto disponibile per questo prodotto.");
      });
    });
  });

  document.getElementById('confirmConsumeBtn').addEventListener('click',()=>{
    const select = document.getElementById('consumeSelect');
    if(!select.value) return;
    const [ins_date, expiry_date, id, product_key, quantity] = select.value.split('|');
    fetch(`/consumed_product?id=${id}&product_key=${product_key}&barcode=${encodeURIComponent(selectedBarcode)}&ins_date=${ins_date}&expiry_date=${expiry_date}&quantity=${quantity}`)
      .then(res=>res.json())
      .then(data=>{
        if(data.success){
          // Aggiorna cella quantit√† (indice 5 dopo rimozione Prezzo/Valore)
          selectedRow.children[5].textContent = data.quantita;
          const btn = selectedRow.querySelector('.consume-btn');
          btn.textContent="‚úÖ";
          btn.classList.replace('btn-warning','btn-success');
          btn.disabled=true;
          bootstrap.Modal.getInstance(document.getElementById('consumeModal')).hide();
          setTimeout(()=>{btn.textContent="üçΩÔ∏è"; btn.classList.replace('btn-success','btn-warning'); btn.disabled=false;},2000);
        } else alert("Errore durante la registrazione del consumo.");
      });
  });
});

// Funzione per rimuovere un elemento dalla lista "Da Scalare" in Home Assistant
function rimuoviDaHA(itemName) {
    // Chiediamo conferma per evitare cancellazioni accidentali
    if (!confirm(`Vuoi rimuovere "${itemName}" dalla lista dei consumati?`)) return;

    // Chiamata alla rotta Python che abbiamo appena creato
    fetch(`/remove_item_ha?entity_id=todo.consumati&item_name=${encodeURIComponent(itemName)}`, {
        method: 'POST'
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            // Ricarichiamo la pagina per vedere la lista aggiornata
            // (Proprio come facciamo nella Shopping List)
            window.location.reload();
        } else {
            alert("Errore durante la rimozione: " + (data.error || "riprova pi√π tardi"));
        }
    })
    .catch(err => {
        console.error("Errore fetch:", err);
        alert("Errore di connessione al server.");
    });
}
</script>
{% endblock %}