{% extends 'layout.html' %}
{% block title %}Inserisci Prodotto{% endblock %}

{% block content %}
<h2>üõí Gestione prodotti</h2>
<br>
<!-- Stile per righe alternate -->
<style>
  thead th {
      background-color: #0050b9 !important;
      color: white !important;
  }

  table.custom-table tbody tr:nth-child(odd) td {
      background-color: #ffffff !important;
  }

  table.custom-table tbody tr:nth-child(even) td {
      background-color: #e7f1ff !important;
  }

  /* üîΩ Stile per la cornice dell'immagine */
  .product-image-frame {
      border: 2px solid #ccc;
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      background-color:  #e6f2ff;
      max-width: 300px;
      text-align: center;
  }

  .product-image-frame img {
      max-width: 100%;
      border-radius: 8px;
  }
  
  .filter-container {
      position: relative;
  }
  .filter-container select {
      padding-right: 30px; /* Spazio per la freccetta */
  }
  .filter-container i {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      transition: transform 0.3s ease; /* Transizione per la rotazione */
  }
  .filter-container.open i {
      transform: translateY(-50%) rotate(180deg); /* Ruota quando il filtro √® aperto */
  }
  
  #advanced-table {
    width: 100%;
    table-layout: auto;
  }
  #advanced-table thead th {
    position: sticky;
    top: 0;
    background-color: #0050b9 !important;
    color: white !important;
    z-index: 2;
  }
  .table-container {
    max-height: 600px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    display: block;
  }

</style>

<!-- Crea le 3 tab -->
<ul class="nav nav-tabs" id="categoryTabs" role="tablist">
  <li class="nav-item" role="presentation">
      <button class="nav-link active" id="add-tab" data-bs-toggle="tab" data-bs-target="#add" type="button" role="tab">
          ‚ûï Aggiungi Prodotto
      </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manage" type="button" role="tab">
        üõ†Ô∏è Modifica/Rimuovi Prodotto
    </button>
  </li>  
  <!-- Tab header -->
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced" type="button" role="tab" aria-controls="advanced" aria-selected="false">
      ‚öôÔ∏è Impostazioni Prodotto
    </button>
  </li>
</ul>

<!-- Contenuto delle tab -->
<div class="tab-content mt-3">
  
  
  <!-- Prima tab: Aggiungi Prodotto -->
  <div class="tab-pane fade show active" id="add" role="tabpanel">
    <div class="row">
      <div class="col-md-7">
        <form method="POST" class="text-start" id="product-form">
            <br> <!-- Aggiungi qui linee vuote -->

            <!-- Barcode -->
            <div class="row mb-2 align-items-center">
                <div class="col-2">
                  <label for="barcode" class="form-label mb-0" style="color: #00008B" >Barcode</label>
                </div>
                <div class="col-5">
                  <input type="text" class="form-control form-control-sm" id="barcode" name="barcode" required maxlength="25" style="background-color:  #e6f2ff;" onchange="autoFillProduct()" onblur="autoFillProduct()">   
                </div>
            </div>

            <!-- Nome -->
            <div class="row mb-2 align-items-center">
              <div class="col-2">
                <label for="name" class="form-label mb-0" style="color: #00008B" >Nome</label>
              </div>
              <div class="col-5">
                <input type="text" class="form-control form-control-sm" id="name" name="name" required maxlength="25" style="background-color:  #e6f2ff;">
              </div>
            </div>
        
            <!-- Marca -->
            <div class="row mb-2 align-items-center">
              <div class="col-2">
                <label for="brand" class="form-label mb-0" style="color: #00008B" >Marca</label>
              </div>
              <div class="col-5">
                <input type="text" class="form-control form-control-sm" id="brand" name="brand" required maxlength="25" style="background-color:  #e6f2ff;">
              </div>
            </div>
        
            <!-- Negozio -->
            <div class="row mb-2 align-items-center">
              <div class="col-2">
                <label for="shop" class="form-label mb-0" style="color: #00008B" >Negozio</label>
              </div>
              <div class="col-5">
                <select class="form-select form-select-sm" id="shop" name="shop" required style="background-color:  #e6f2ff;">
                  <option value="">Seleziona un negozio</option>
                  {% for shop in shops %}
                    <option value="{{ shop[1] }}">{{ shop[1] }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
        
            <!-- Prezzo -->
            <div class="row mb-2 align-items-center">
              <div class="col-2">
                <label for="price" class="form-label mb-0" style="color: #00008B" >Prezzo</label>
              </div>
              <div class="col-5">
                <input type="number" step="0.01" class="form-control form-control-sm" id="price" name="price" required style="background-color:  #e6f2ff;">
              </div>
            </div>
        
            <!-- Quantit√† dei pezzi acquistati-->
            <div class="row mb-2 align-items-center">
              <div class="col-2">
                <label for="quantity" class="form-label mb-0" style="color: #00008B" >Quantita`</label>
              </div>
              <div class="col-5">
                <input type="number" min="1" class="form-control form-control-sm" id="quantity" name="quantity" required style="background-color:  #e6f2ff;">
              </div>
            </div>


 
            <!-- Items -->
            <div class="row mb-2 align-items-center">
              <div class="col-2">
                <label for="item" class="form-label mb-0" style="color: #00008B" >Articolo</label>
              </div>
              <div class="col-5">
                <select class="form-select form-select-sm" id="item" name="item" required style="background-color:  #e6f2ff;">
                  <option value="">Seleziona un tipo di articolo</option>
                  {% for cat in items %}
                    <option value="{{ cat[1] }}">{{ cat[1] }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>


            <!-- Scadenza -->
            <div class="row mb-2 align-items-center">
              <div class="col-2">
                <label for="expiry_date" class="form-label mb-0" style="color: #00008B" >Scadenza</label>
              </div>
              <div class="col-5">
                <input type="date" class="form-control form-control-sm" id="expiry_date" name="expiry_date" style="background-color:  #e6f2ff;">
              </div>
            </div>

            <!-- Submit -->
            <button type="submit" class="btn btn-primary mt-2">Aggiungi Prodotto</button>

        </form>
      </div>
      
      <div class="product-image-frame">
        <img id="productImage" src="" alt="Immagine prodotto" style="display: none; max-width: 100%;">
        <p id="image-placeholder" class="text-muted">üîç Inserisci un barcode per vedere l'immagine.</p>
      </div>

    </div>
    <hr class="my-4">

    {% if new_product %}
    <h3>Prodotto appena inserito</h3>
    <table class="table table-bordered mt-3 text-center">
      <thead>
        <tr>
          <th>Nome</th><th>Marca</th><th>Negozio</th><th>Prezzo</th>
          <th>Quantit√†</th><th>Categoria</th><th>Item</th><th>Data Scadenza</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>{{ new_product.name }}</td>
          <td>{{ new_product.brand }}</td>
          <td>{{ new_product.shop }}</td>
          <td>{{ new_product.price }}</td>
          <td>{{ new_product.quantity }}</td>
          <td>{{ new_product.category }}</td>
          <td>{{ new_product.item }}</td>
          <td>{{ new_product.expiry_date }}</td>
        </tr>
      </tbody>
    </table>
    {% endif %}

    
  </div>

  <!-- Seconda tab: Modifica/Rimuovi Prodotto -->
  <div class="tab-pane fade" id="manage" role="tabpanel">
    <div class="table-container" style="max-height: 600px; overflow-y: auto; border: 1px solid #dee2e6;">
      <table class="table table-striped custom-table">
        <thead style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 1;">
          <tr>
            <th>Immagine</th>
            <th>
              Nome
              <select id="filter-name" onchange="filterTable()">
                <option value="">Tutti</option>
                {% set names = products | map(attribute='name') | unique | sort %}
                {% for name in names %}
                  <option value="{{ name }}">{{ name }}</option>
                {% endfor %}
              </select>
            </th>
            <th>Negozio</th>
            <th>Prezzo</th>
            <th>Quantita</th>
            <th>
              Categoria
              <select id="filter-category" onchange="filterTable()">
                <option value="">Tutti</option>
                {% set categories = products | map(attribute='category') | unique | sort %}
                {% for category in categories %}
                  <option value="{{ category }}">{{ category }}</option>
                {% endfor %}
              </select>
            </th>
            <th>
              Articolo
              <select id="filter-item" onchange="filterTable()">
                <option value="">Tutti</option>
                {% set items = products | map(attribute='item') | unique | sort %}
                {% for item in items %}
                  <option value="{{ item }}">{{ item }}</option>
                {% endfor %}
              </select>
            </th>
            <th>Inserito il</th>
            <th>Scadenza</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody id="product-table-body">
          {% for product in products %}
          <tr>
            <td>
              {% if product.image %}
                <img src="{{ product.image }}" alt="Immagine prodotto" width="50">
              {% else %}
                N/A
              {% endif %}
            </td>
            <td>{{ product.name }}</td>
            <td>{{ product.shop }}</td>
            <td>{{ product.price }} ‚Ç¨</td>
            <td>{{ product.quantity }}</td>
            <td>{{ product.category }}</td>
            <td>{{ product.item }}</td>
            <td>{{ product.ins_date }}</td>
            <td>{{ product.expiry_date if product.expiry_date else 'N/A' }}</td>
            <td>
              <a href="{{ url_for('main.edit_product', name=product.name, ins_date=product.ins_date) }}" class="btn btn-sm btn-warning">‚úèÔ∏è Modifica</a>
              <a href="{{ url_for('main.delete_product', id=product.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('Sei sicuro di voler eliminare questo negozio?');">‚ùå Elimina</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

<script>
  function filterTable() {
    const nameFilter = document.getElementById("filter-name").value.toLowerCase();
    const categoryFilter = document.getElementById("filter-category").value.toLowerCase();
    const itemFilter = document.getElementById("filter-item").value.toLowerCase();
    
    const rows = document.querySelectorAll("#product-table-body tr");
    
    rows.forEach(row => {
      const name = row.cells[1].textContent.toLowerCase();
      const category = row.cells[5].textContent.toLowerCase();
      const item = row.cells[6].textContent.toLowerCase();
      
      if ((nameFilter === "" || name.includes(nameFilter)) &&
          (categoryFilter === "" || category.includes(categoryFilter)) &&
          (itemFilter === "" || item.includes(itemFilter))) {
        row.style.display = "";
      } else {
        row.style.display = "none";
      }
    });
  }
</script>

  <!-- Terza tab - ‚öôÔ∏è Impostazioni avanzate ottimizzazione spesa -->
  <div class="tab-pane fade" id="advanced" role="tabpanel" aria-labelledby="advanced-tab">
    <div id="inventory-container">
      <div class="table-container" style="max-height: 600px; overflow-y: auto; border: 1px solid #dee2e6;">
        <table class="table table-bordered custom-table" id="advanced-table">
          <thead class="table-dark">
            <tr>
              <th>Prodotto</th>
              <th>Barcode</th>
              <th>Nome</th>
              <th>
                <label for="filterTipoProdotto">Tipo:</label>
                <select id="filterTipoProdotto">
                  <option value="">Mostra Tutti</option>
                  <option value="Indispensabile">Indispensabile</option>
                  <option value="Utile">Utile</option>
                  <option value="Occasionale">Occasionale</option>
                  <option value="Stagionale">Stagionale</option>
                </select>
              </th>
              <th>
                <label for="filterStagione">Stagione:</label>
                <select id="filterStagione">
                  <option value="">Mostra Tutti</option>
                  <option value="Primavera">Primavera</option>
                  <option value="Estate">Estate</option>
                  <option value="Autunno">Autunno</option>
                  <option value="Inverno">Inverno</option>
                  <option value="Tutte">Tutte</option>
                </select>
              </th>
              <th>Priorit√†</th>
              <th>Azioni</th>
            </tr>
          </thead>
          <tbody id="advanced-table-body">
            <!-- Popolato via JS -->
          </tbody>
        </table>
      </div>
    </div>
  </div>


<!-- questo script Riempie la prima TAB -->
<script>
  function autoFillProduct() {
    const barcode = document.getElementById("barcode").value.trim();
    const name = document.getElementById("name").value.trim();

    let lookupURL = "";

    if (barcode) {
      lookupURL = `/lookup?barcode=${encodeURIComponent(barcode)}`;
    } else if (name) {
      lookupURL = `/lookup?name=${encodeURIComponent(name)}`;
    } else {
      console.log("Nessun dato per la lookup.");
      return;
    }

    fetch(lookupURL)
      .then(response => response.json())
      .then(data => {
        console.log("Risultato lookup DB:", data);

        if (data.found) {
          document.getElementById("name").value = data.name || '';
          document.getElementById("brand").value = data.brand || '';
          document.getElementById("shop").value = data.shop || '';
          document.getElementById("price").value = data.price || '';
          document.getElementById("quantity").value = data.quantity || 1;
          document.getElementById("item").value = data.item || '';

          if (data.image) {
            console.log("Immagine trovata:", data.image);
            document.getElementById("productImage").src = data.image;
            document.getElementById("productImage").style.display = "block";
            document.getElementById("image-placeholder").style.display = "none";
          } else {
            console.log("Nessuna immagine trovata nel DB.");
            document.getElementById("productImage").style.display = "none";
            document.getElementById("image-placeholder").style.display = "block";
          }

        } else {
          if (barcode) {
            console.log("Prodotto non trovato nel DB. Provo lookup online...");
            fetch(`/lookup_online/${barcode}`)
              .then(response => response.json())
              .then(onlineData => {
                console.log("Risultato lookup online:", onlineData);
                if (onlineData.found) {
                  document.getElementById("name").value = onlineData.name || '';
                  document.getElementById("brand").value = onlineData.brand || '';
                  document.getElementById("quantity").value = onlineData.quantity || 1;

                  if (onlineData.image) {
                    document.getElementById("productImage").src = onlineData.image;
                    document.getElementById("productImage").style.display = "block";
                    document.getElementById("image-placeholder").style.display = "none";
                  } else {
                    document.getElementById("productImage").style.display = "none";
                    document.getElementById("image-placeholder").style.display = "block";
                  }
                }
              })
              .catch(error => console.error("Errore lookup online:", error));
          } else {
            console.log("Nessun barcode disponibile per il lookup online.");
          }
        }
      })
      .catch(error => console.error("Errore lookup DB:", error));
  }
</script>


<!-- questo script Riempie la terza TAB -->
<script>
  function setupAdvancedFilters() {
    const tipoSelect = document.getElementById("filterTipoProdotto");
    const stagioneSelect = document.getElementById("filterStagione");

    if (tipoSelect) {
      tipoSelect.addEventListener("change", function () {
        let filtro = this.value.toLowerCase();
        document.querySelectorAll("#advanced-table tbody tr").forEach(riga => {
          let tipo = riga.querySelector("td:nth-child(4) select");
          if (tipo) {
            let valore = tipo.value.toLowerCase();
            riga.style.display = (filtro === "" || valore === filtro) ? "" : "none";
          }
        });
      });
    }

    if (stagioneSelect) {
      stagioneSelect.addEventListener("change", function () {
        let filtro = this.value.toLowerCase();
        document.querySelectorAll("#advanced-table tbody tr").forEach(riga => {
          let stagione = riga.querySelector("td:nth-child(5) select");
          if (stagione) {
            let valore = stagione.value.toLowerCase();
            riga.style.display = (filtro === "" || valore === filtro) ? "" : "none";
          }
        });
      });
    }
  }
</script>

<script>
  function fetchAdvancedTable() {
    fetch("/products/advanced")
      .then(res => res.json())
      .then(data => {
        const tbody = document.querySelector("#advanced-table tbody");
        if (!tbody) {
          console.error("‚ùå #advanced-table tbody non trovato!");
          return;
        }
        tbody.innerHTML = "";
        console.log("üì¶ Dati ricevuti:", data.products);

        if (data.found && Array.isArray(data.products)) {
          data.products.forEach(product => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${product.image ? `<img src="${product.image}" alt="img" style="max-width: 60px;">` : '<span class="text-muted">Nessuna immagine</span>'}</td>
              <td>${product.barcode || "-"}</td>
              <td>${product.name || "-"}</td>
              <td>
                <select class="tipo-prodotto">
                  <option value="" ${!product.product_type ? "selected" : ""} disabled>-- Seleziona --</option>
                  <option value="Indispensabile" ${product.product_type === "Indispensabile" ? "selected" : ""}>Indispensabile</option>
                  <option value="Utile" ${product.product_type === "Utile" ? "selected" : ""}>Utile</option>
                  <option value="Occasionale" ${product.product_type === "Occasionale" ? "selected" : ""}>Occasionale</option>
                  <option value="Stagionale" ${product.product_type === "Stagionale" ? "selected" : ""}>Stagionale</option>
                </select>
              </td>
              <td>
                <select class="stagione">
                  <option value="" ${!product.seasons ? "selected" : ""} disabled>-- Seleziona --</option>
                  <option value="Primavera" ${product.seasons === "Primavera" ? "selected" : ""}>Primavera</option>
                  <option value="Estate" ${product.seasons === "Estate" ? "selected" : ""}>Estate</option>
                  <option value="Autunno" ${product.seasons === "Autunno" ? "selected" : ""}>Autunno</option>
                  <option value="Inverno" ${product.seasons === "Inverno" ? "selected" : ""}>Inverno</option>
                  <option value="Tutte" ${product.seasons === "Tutte" ? "selected" : ""}>Tutte</option>
                </select>
              </td>
              <td>${product.priority_level || "-"}</td>
              <td>
                <button class="btn btn-sm btn-success save-advanced-btn" style="display:none;" data-barcode="${product.barcode}">üíæ Salva</button>
              </td>
            `;
            tbody.appendChild(row);
          });

          bindUpdateButtons();
          setupAdvancedFilters(); // üîÅ Ricollega i filtri
        } else {
          tbody.innerHTML = "<tr><td colspan='7'>Nessun prodotto avanzato trovato.</td></tr>";
        }
      })
      .catch(err => console.error("üö® Errore nel fetch:", err));
  }

  function bindUpdateButtons() {
    document.querySelectorAll(".update-btn").forEach(button => {
      button.addEventListener("click", function () {
        const row = this.closest("tr");
        const barcode = this.dataset.barcode;
        const product_type = row.querySelector(".tipo-prodotto").value;
        const seasons = row.querySelector(".stagione").value;

        console.log("üì§ Aggiorno:", barcode, product_type, seasons);

        fetch("/inventory/advanced/update", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ barcode, product_type, seasons })
        })
          .then(response => response.text())
          .then(html => {
            const container = document.querySelector("#inventory-container");
            if (container) {
              container.innerHTML = html;

              const tab = new bootstrap.Tab(document.querySelector('#add-tab'));
              tab.show();

              fetchAdvancedTable(); // Ricarica tabella aggiornata
              const successMessage = document.createElement('div');
              successMessage.className = 'alert alert-success';
              successMessage.innerHTML = 'Prodotto aggiornato con successo!';
              document.querySelector('#add-tab').prepend(successMessage);
              setTimeout(() => successMessage.remove(), 3000);
            } else {
              location.reload();
            }
            alert("‚úÖ Aggiornamento riuscito!");
          })
          .catch(error => {
            console.error("‚ùå Errore:", error);
            alert("Errore durante l'aggiornamento.");
          });
      });
    });
  }
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const advancedTabButton = document.querySelector('#add-tab');
    if (advancedTabButton) {
      advancedTabButton.addEventListener('shown.bs.tab', function () {
        fetchAdvancedTable(); // Carica dati al cambio tab
      });
    }
    setupAdvancedFilters(); // Inizializza i filtri al primo caricamento
  });
</script>


<script>
  function setupAdvancedFilters() {
    const tipoSelect = document.getElementById("filterTipoProdotto");
    const stagioneSelect = document.getElementById("filterStagione");

    if (tipoSelect) {
      tipoSelect.addEventListener("change", function () {
        let filtro = this.value.toLowerCase();
        document.querySelectorAll("#advanced-table tbody tr").forEach(riga => {
          let tipo = riga.querySelector("td:nth-child(4) select");
          if (tipo) {
            let valore = tipo.value.toLowerCase();
            riga.style.display = (filtro === "" || valore === filtro) ? "" : "none";
          }
        });
      });
    }

    if (stagioneSelect) {
      stagioneSelect.addEventListener("change", function () {
        let filtro = this.value.toLowerCase();
        document.querySelectorAll("#advanced-table tbody tr").forEach(riga => {
          let stagione = riga.querySelector("td:nth-child(5) select");
          if (stagione) {
            let valore = stagione.value.toLowerCase();
            riga.style.display = (filtro === "" || valore === filtro) ? "" : "none";
          }
        });
      });
    }
  }
</script>

<script>
  function fetchAdvancedTable() {
    fetch("/products/advanced")
      .then(res => res.json())
      .then(data => {
        const tbody = document.querySelector("#advanced-table tbody");
        if (!tbody) {
          console.error("‚ùå #advanced-table tbody non trovato!");
          return;
        }
        tbody.innerHTML = "";
        console.log("üì¶ Dati ricevuti:", data.products);

        if (data.found && Array.isArray(data.products)) {
          data.products.forEach(product => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${product.image ? `<img src="${product.image}" alt="img" style="max-width: 60px;">` : '<span class="text-muted">Nessuna immagine</span>'}</td>
              <td>${product.barcode || "-"}</td>
              <td>${product.name || "-"}</td>
              <td>
                <select class="tipo-prodotto">
                  <option value="" ${!product.product_type ? "selected" : ""} disabled>-- Seleziona --</option>
                  <option value="Indispensabile" ${product.product_type === "Indispensabile" ? "selected" : ""}>Indispensabile</option>
                  <option value="Utile" ${product.product_type === "Utile" ? "selected" : ""}>Utile</option>
                  <option value="Occasionale" ${product.product_type === "Occasionale" ? "selected" : ""}>Occasionale</option>
                  <option value="Stagionale" ${product.product_type === "Stagionale" ? "selected" : ""}>Stagionale</option>
                </select>
              </td>
              <td>
                <select class="stagione">
                  <option value="" ${!product.seasons ? "selected" : ""} disabled>-- Seleziona --</option>
                  <option value="Primavera" ${product.seasons === "Primavera" ? "selected" : ""}>Primavera</option>
                  <option value="Estate" ${product.seasons === "Estate" ? "selected" : ""}>Estate</option>
                  <option value="Autunno" ${product.seasons === "Autunno" ? "selected" : ""}>Autunno</option>
                  <option value="Inverno" ${product.seasons === "Inverno" ? "selected" : ""}>Inverno</option>
                  <option value="Tutte" ${product.seasons === "Tutte" ? "selected" : ""}>Tutte</option>
                </select>
              </td>
              <td>${product.priority_level || "-"}</td>
              <td>
                <button class="btn btn-sm btn-success save-advanced-btn" style="display:none;" data-barcode="${product.barcode}">üíæ Salva</button>
              </td>
            `;
            tbody.appendChild(row);

            // Mostra il tasto Salva quando si cambia un select
            row.querySelectorAll('.tipo-prodotto, .stagione').forEach(function(select) {
              select.addEventListener('change', function() {
                const saveBtn = row.querySelector('.save-advanced-btn');
                if (saveBtn) saveBtn.style.display = '';
              });
            });


            // Gestione click sul tasto Salva e faccine
            row.querySelector('.save-advanced-btn').addEventListener('click', function() {
              const saveBtn = this;
              const product_type = row.querySelector('.tipo-prodotto').value;
              const seasons = row.querySelector('.stagione').value;
              const barcode = row.children[1].textContent.trim();

              fetch("/inventory/advanced/update", {
                method: "POST",
                headers: {
                  "Content-Type": "application/x-www-form-urlencoded",
                  "X-Requested-With": "XMLHttpRequest"
                },
                body: new URLSearchParams({ barcode, product_type, seasons })
              })
              .then(response => response.json())
              .then(data => {
                saveBtn.style.display = 'none';
                let icon = document.createElement('span');
                icon.style.fontSize = '1.5em';
                icon.style.marginLeft = '5px';
                if (data.success) {
                  icon.textContent = 'üòä';
                  icon.style.color = 'green';
                } else {
                  icon.textContent = 'üòû';
                  icon.style.color = 'red';
                }
                saveBtn.parentNode.appendChild(icon);
                setTimeout(() => {
                  icon.remove();
                  if (data.success) fetchAdvancedTable(); // <-- ora qui!
                }, 2000);
              })
              .catch(error => {
                saveBtn.style.display = 'none';
                let icon = document.createElement('span');
                icon.textContent = 'üòû';
                icon.style.color = 'red';
                icon.style.fontSize = '1.5em';
                icon.style.marginLeft = '5px';
                saveBtn.parentNode.appendChild(icon);
                setTimeout(() => {
                  icon.remove();
                }, 2000);
              });
            });


          });

          bindUpdateButtons();
          setupAdvancedFilters(); // üîÅ Riapplica i filtri
        } else {
          tbody.innerHTML = "<tr><td colspan='7'>Nessun prodotto avanzato trovato.</td></tr>";
        }
      })
      .catch(err => console.error("üö® Errore nel fetch:", err));
  }

  function bindUpdateButtons() {
    document.querySelectorAll(".update-btn").forEach(button => {
      button.addEventListener("click", function () {
        const row = this.closest("tr");
        const barcode = this.dataset.barcode;
        const product_type = row.querySelector(".tipo-prodotto").value;
        const seasons = row.querySelector(".stagione").value;

        console.log("üì§ Aggiorno:", barcode, product_type, seasons);

        fetch("/inventory/advanced/update", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-Requested-With": "XMLHttpRequest"
          },
          body: new URLSearchParams({ barcode, product_type, seasons })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const successMessage = document.createElement('div');
            successMessage.className = 'alert alert-success mt-2';
            successMessage.innerText = '‚úÖ Prodotto aggiornato con successo!';
            document.querySelector('#inventory-container').prepend(successMessage);
            setTimeout(() => successMessage.remove(), 3000);

            fetchAdvancedTable(); // üîÅ Ricarica i dati aggiornati
          } else {
            alert("‚ùå Errore nell'aggiornamento del prodotto.");
          }
        })
        .catch(error => {
          console.error("‚ùå Errore:", error);
          alert("Errore durante l'aggiornamento.");
        });
      });
    });
  }

  // ‚úÖ Esegui fetch iniziale
  fetchAdvancedTable();
</script>



<script>
  document.addEventListener("DOMContentLoaded", function () {
    const advancedTabButton = document.querySelector('#add-tab');
    if (advancedTabButton) {
      advancedTabButton.addEventListener('shown.bs.tab', function () {
        fetchAdvancedTable(); // Carica dati al cambio tab
      });
    }
    setupAdvancedFilters(); // Inizializza i filtri al primo caricamento
  });
</script>

{% endblock %}
