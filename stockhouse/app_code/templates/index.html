{% extends 'layout.html' %}
{% block title %}Inserisci Prodotto{% endblock %}

{% block content %}
<h2>üõí Gestione prodotti</h2>
<br>
<!-- Stile per righe alternate -->
<style>
  .custom-table thead {
      background-color: #0050b9 !important;
      color: white !important;
      position: sticky;
      top: 0;
      z-index: 10;
  }
  .custom-table th, .custom-table td {
      border: 2px solid #dee2e6;
      padding: 10px;
      text-align: center;
  }
  .custom-table {
    border-collapse: collapse !important;
  }
  .custom-table tbody tr:nth-child(odd) td {
      background-color: #ffffff !important;
  }
  .custom-table tbody tr:nth-child(even) td {
      background-color: #dcf5fe6a !important;
  }
  .table-dark {
      background-color: #0050b9 !important;
      color: white !important;
  }
  .table-container {
      max-height: 600px;
      overflow-y: auto;
      border: 2px solid #007BA7;
      display: block;
  }
  .custom-table thead {
      position: sticky;
      top: 0;
      background-color: #0050b9;
      z-index: 10;
  }
  .table-container .row.bg-primary {
      background-color: transparent !important;
  }
  .consume-btn {
    min-width: 160px; /* Scegli la larghezza che preferisci */
  }

  /* üîΩ Stile per la cornice dell'immagine */
  .product-image-frame {
      border: 2px solid #ccc;
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      background-color:  #e6f2ff;
      max-width: 300px;
      text-align: center;
  }

  .product-image-frame img {
      max-width: 100%;
      border-radius: 8px;
  }

  #filterNameList {
    width: 225px;         /* oppure 220px o anche 240px */
    min-width: 200px;
    padding: 6px 10px;
    font-size: 14px;
    border-radius: 6px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }

  .table-select-necessity {
  width: 100%;           /* Occupa tutta la cella */
  min-width: 125px;      /* Larghezza minima decente */
  text-align: left;  
  padding: 8px;
  font-size: 14px;
  box-sizing: border-box;
}

.table-select-season {
  width: 100%;           /* Occupa tutta la cella */
  min-width: 100px;      /* Larghezza minima decente */
  direction: ltr;        /* Assicura che il testo scorra da sinistra */
  text-align: left;  
  padding: 8px;
  font-size: 14px;
  box-sizing: border-box;
}
</style> 


<!-- Crea le 3 tab -->
<ul class="nav nav-tabs" id="categoryTabs" role="tablist">
  <li class="nav-item" role="presentation">
      <button class="nav-link active" id="add-tab" data-bs-toggle="tab" data-bs-target="#add" type="button" role="tab">
          ‚ûï Aggiungi Prodotto
      </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manage" type="button" role="tab">
        üõ†Ô∏è Modifica/Rimuovi Prodotto
    </button>
  </li>  
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="list-tab" data-bs-toggle="tab" data-bs-target="#list" type="button" role="tab" aria-controls="list" aria-selected="false">
       ‚öôÔ∏è Impostazioni di prodotto
    </button>
  </li>
</ul>

<!-- Contenuto delle tab -->
<div class="tab-content mt-3">
  
  
  <!-- Prima tab: Aggiungi Prodotto -->
  <div class="tab-pane fade show active" id="add" role="tabpanel">
    <div class="row">
      <div class="col-md-7">
        <form method="POST" class="text-start" id="product-form">
            <br> <!-- Aggiungi qui linee vuote -->

            <!-- Barcode -->
            <div class="row mb-2 align-items-center">
                <div class="col-2">
                  <label for="barcode" class="form-label mb-0" style="color: #00008B" >Barcode</label>
                </div>
                <div class="col-5">
                  <input type="text" class="form-control form-control-sm" id="barcode" name="barcode" required maxlength="25" style="background-color:  #e6f2ff;" onchange="autoFillProduct()" onblur="autoFillProduct()">   
                </div>
            </div>

            <!-- Nome -->
            <div class="row mb-2 align-items-center">
              <div class="col-2">
                <label for="name" class="form-label mb-0" style="color: #00008B" >Nome</label>
              </div>
              <div class="col-5">
                <input type="text" class="form-control form-control-sm" id="name" name="name" required maxlength="25" style="background-color:  #e6f2ff;">
              </div>
            </div>
        
            <!-- Marca -->
            <div class="row mb-2 align-items-center">
              <div class="col-2">
                <label for="brand" class="form-label mb-0" style="color: #00008B" >Marca</label>
              </div>
              <div class="col-5">
                <input type="text" class="form-control form-control-sm" id="brand" name="brand" required maxlength="25" style="background-color:  #e6f2ff;">
              </div>
            </div>
        
            <!-- Negozio -->
            <div class="row mb-2 align-items-center">
              <div class="col-2">
                <label for="shop" class="form-label mb-0" style="color: #00008B" >Negozio</label>
              </div>
              <div class="col-5">
                <select class="form-select form-select-sm" id="shop" name="shop" required style="background-color:  #e6f2ff;">
                  <option value="">Seleziona un negozio</option>
                  {% for shop in shops %}
                    <option value="{{ shop[1] }}">{{ shop[1] }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
        
            <!-- Prezzo -->
            <div class="row mb-2 align-items-center">
              <div class="col-2">
                <label for="price" class="form-label mb-0" style="color: #00008B" >Prezzo</label>
              </div>
              <div class="col-5">
                <input type="number" step="0.01" class="form-control form-control-sm" id="price" name="price" required style="background-color:  #e6f2ff;">
              </div>
            </div>
        
            <!-- Quantit√† dei pezzi acquistati-->
            <div class="row mb-2 align-items-center">
              <div class="col-2">
                <label for="quantity" class="form-label mb-0" style="color: #00008B" >Quantita`</label>
              </div>
              <div class="col-5">
                <input type="number" min="1" class="form-control form-control-sm" id="quantity" name="quantity" required style="background-color:  #e6f2ff;">
              </div>
            </div>


 
            <!-- Items -->
            <div class="row mb-2 align-items-center">
              <div class="col-2">
                <label for="item" class="form-label mb-0" style="color: #00008B" >Articolo</label>
              </div>
              <div class="col-5">
                <select class="form-select form-select-sm" id="item" name="item" required style="background-color:  #e6f2ff;">
                  <option value="">Seleziona un tipo di articolo</option>
                  {% for cat in items %}
                    <option value="{{ cat[1] }}">{{ cat[1] }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>


            <!-- Scadenza -->
            <div class="row mb-2 align-items-center">
              <div class="col-2">
                <label for="expiry_date" class="form-label mb-0" style="color: #00008B" >Scadenza</label>
              </div>
              <div class="col-5">
                <input type="date" class="form-control form-control-sm" id="expiry_date" name="expiry_date" style="background-color:  #e6f2ff;">
              </div>
            </div>

            <!-- Submit -->
            <button type="submit" class="btn btn-primary mt-2">Aggiungi Prodotto</button>

        </form>
      </div>
      
      <div class="product-image-frame">
        <img id="productImage" src="" alt="Immagine prodotto" style="display: none; max-width: 100%;">
        <p id="image-placeholder" class="text-muted">üîç Inserisci un barcode per vedere l'immagine.</p>
      </div>

    </div>
    <hr class="my-4">

    {% if new_product %}
    <h3>Prodotto appena inserito</h3>
    <table class="table table-bordered mt-3 text-center">
      <thead>
        <tr>
          <th>Nome</th><th>Marca</th><th>Negozio</th><th>Prezzo</th>
          <th>Quantit√†</th><th>Categoria</th><th>Item</th><th>Data Scadenza</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>{{ new_product.name }}</td>
          <td>{{ new_product.brand }}</td>
          <td>{{ new_product.shop }}</td>
          <td>{{ new_product.price }}</td>
          <td>{{ new_product.quantity }}</td>
          <td>{{ new_product.category }}</td>
          <td>{{ new_product.item }}</td>
          <td>{{ new_product.expiry_date }}</td>
        </tr>
      </tbody>
    </table>
    {% endif %}

    
  </div>

  <!-- Seconda tab: Modifica/Rimuovi Prodotto -->
  <div class="tab-pane fade" id="manage" role="tabpanel">
    <div class="table-container" style="max-height: 600px; overflow-y: auto; border: 1px solid #dee2e6;">
      <table class="table table-striped custom-table">
        <thead style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 1;">
          <tr>
            <th>Immagine</th>
            <th>
              Nome
              <select id="filter-name" onchange="filterTable()">
                <option value="">Tutti</option>
                {% set names = products | map(attribute='name') | unique | sort %}
                {% for name in names %}
                  <option value="{{ name }}">{{ name }}</option>
                {% endfor %}
              </select>
            </th>
            <th>Negozio</th>
            <th>Prezzo</th>
            <th>Quantita</th>
            <th>
              Categoria
              <select id="filter-category" onchange="filterTable()">
                <option value="">Tutti</option>
                {% set categories = products | map(attribute='category') | unique | sort %}
                {% for category in categories %}
                  <option value="{{ category }}">{{ category }}</option>
                {% endfor %}
              </select>
            </th>
            <th>
              Articolo
              <select id="filter-item" onchange="filterTable()">
                <option value="">Tutti</option>
                {% set items = products | map(attribute='item') | unique | sort %}
                {% for item in items %}
                  <option value="{{ item }}">{{ item }}</option>
                {% endfor %}
              </select>
            </th>
            <th>Inserito il</th>
            <th>Scadenza</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody id="product-table-body">
          {% for product in products %}
          <tr>
            <td>
              {% if product.image %}
                <img src="{{ product.image }}" alt="Immagine prodotto" width="50">
              {% else %}
                N/A
              {% endif %}
            </td>
            <td>{{ product.name }}</td>
            <td>{{ product.shop }}</td>
            <td>{{ product.price }} ‚Ç¨</td>
            <td>{{ product.quantity }}</td>
            <td>{{ product.category }}</td>
            <td>{{ product.item }}</td>
            <td>{{ product.ins_date }}</td>
            <td>{{ product.expiry_date if product.expiry_date else 'N/A' }}</td>
            <td>
              <a href="{{ url_for('main.edit_product', name=product.name, ins_date=product.ins_date) }}" class="btn btn-sm btn-warning">‚úèÔ∏è Modifica</a>
              <a href="{{ url_for('main.delete_product', id=product.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('Sei sicuro di voler eliminare questo negozio?');">‚ùå Elimina</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

<script>
  function filterTable() {
    const nameFilter = document.getElementById("filter-name").value.toLowerCase();
    const categoryFilter = document.getElementById("filter-category").value.toLowerCase();
    const itemFilter = document.getElementById("filter-item").value.toLowerCase();
    
    const rows = document.querySelectorAll("#product-table-body tr");
    
    rows.forEach(row => {
      const name = row.cells[1].textContent.toLowerCase();
      const category = row.cells[5].textContent.toLowerCase();
      const item = row.cells[6].textContent.toLowerCase();
      
      if ((nameFilter === "" || name.includes(nameFilter)) &&
          (categoryFilter === "" || category.includes(categoryFilter)) &&
          (itemFilter === "" || item.includes(itemFilter))) {
        row.style.display = "";
      } else {
        row.style.display = "none";
      }
    });
  }
</script>

 <!-- terza tab - ‚öôÔ∏è Impostazioni di prodotto -->
  <div class="tab-pane fade" id="list" role="tabpanel" aria-labelledby="list-tab">
    <div class="table-container">
      <table class="table table-bordered custom-table" id="list-table">
        <thead class="table-dark">
          <tr>
            <th>Prodotto</th>
            <th>Nome</th>
            <th>Necessita`</th>
            <th>Stagione</th>
            <th>Priorita`</th>
            <th>Scorta Min</th>
            <th>Scorta Max</th>
            <th>Scorta Sicurezza</th>
            <th>Punto Ordine</th>
            <th>Media Durata</th>
            <th>Media Ordine</th>
            <th>Auto Sync</th>
            <th>Azioni</th>
          </tr>
          <tr>
            <th></th>
            <th>
              <select id="filterNameList" class="form-select form-select-sm">
                <option value="">Tutti</option>
              </select>
            </th>

            </th>
            <th colspan="11"></th>
          </tr>
        </thead>
        <tbody>
          {% for product in products %}
          <tr data-barcode="{{ product.barcode }}">
            <td>
              {% if product.image %}
                <img src="{{ product.image }}" alt="Immagine prodotto" style="max-width: 80px; height: auto;">
              {% else %}
                <span class="text-muted">Nessuna immagine</span>
              {% endif %}
            </td>
            <td>{{ product.name }}</td>
            <!-- Necessit√† (dropdown) -->
            <td>
              <select class="table-select-necessity select-editable" name="Necessita`" data-field="necessity_level">
                <option value="Indispensabile" {% if product.necessity_level == 'Indispensabile' %}selected{% endif %}>Indispensabile</option>
                <option value="Utile" {% if product.necessity_level == 'Utile' %}selected{% endif %}>Utile</option>
                <option value="Occasionale" {% if product.necessity_level == 'Occasionale' %}selected{% endif %}>Occasionale</option>
                <option value="Stagionale" {% if product.necessity_level == 'Stagionale' %}selected{% endif %}>Stagionale</option>
              </select>
            </td>

            <!-- Stagione (dropdown) -->
            <td>
              <select class="table-select-season select-editable" name="Stagione`" data-field="season">
                <option value="Primavera" {% if product.season == 'Primavera' %}selected{% endif %}>Primavera</option>
                <option value="Estate" {% if product.season == 'Estate' %}selected{% endif %}>Estate</option>
                <option value="Autunno" {% if product.season == 'Autunno' %}selected{% endif %}>Autunno</option>
                <option value="Inverno" {% if product.season == 'Inverno' %}selected{% endif %}>Inverno</option>
              </select>
            </td>
            
            <td class="priority-cell">{{ product.priority_level or "-" }}</td>
            <td>
              <input type="number"  min="0" class="form-control form-control-sm inline-edit" data-field="min_quantity"
                 value="{{ product.min_quantity if product.min_quantity is not none else '' }}">
            </td>
            <td>
              <input type="number"  min="0" class="form-control form-control-sm inline-edit" data-field="max_quantity"
                value="{{ product.max_quantity if product.max_quantity is not none else '' }}">
            </td>
            <td>
              <input type="number"  min="0" class="form-control form-control-sm inline-edit" data-field="security_quantity"
                value="{{ product.security_quantity if product.security_quantity is not none else '' }}">
            </td>
            <td>
              <input type="number"  min="0" class="form-control form-control-sm inline-edit" data-field="reorder_point"
                value="{{ product.reorder_point if product.reorder_point is not none else '' }}">
            </td>
            <td>
              <input type="number"  min="0" class="form-control form-control-sm inline-edit mean-usage" data-field="mean_usage_time"
                value="{{ product.mean_usage_time or '' }}">
            </td>
            <td>
              <input type="number"  min="0" class="form-control form-control-sm inline-edit reorder-freq" data-field="reorder_frequency"
                value="{{ product.reorder_frequency or '' }}">
            </td>
            <td>
              <input type="checkbox" class="form-check-input auto-update-checkbox"
                data-field="user_override"
                {% if product.user_override == 1 %}checked{% endif %}>
            </td>
            <td>
              <button class="btn btn-sm btn-success save-row-btn" style="display:none;">üíæ Salva</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>



<!-- questo script Riempie la prima TAB -->
<script>
  function autoFillProduct() {
    const barcode = document.getElementById("barcode").value.trim();
    const name = document.getElementById("name").value.trim();

    let lookupURL = "";

    if (barcode) {
      lookupURL = `/lookup?barcode=${encodeURIComponent(barcode)}`;
    } else if (name) {
      lookupURL = `/lookup?name=${encodeURIComponent(name)}`;
    } else {
      console.log("Nessun dato per la lookup.");
      return;
    }

    fetch(lookupURL)
      .then(response => response.json())
      .then(data => {
        console.log("Risultato lookup DB:", data);

        if (data.found) {
          document.getElementById("name").value = data.name || '';
          document.getElementById("brand").value = data.brand || '';
          document.getElementById("shop").value = data.shop || '';
          document.getElementById("price").value = data.price || '';
          document.getElementById("quantity").value = data.quantity || 1;
          document.getElementById("item").value = data.item || '';

          if (data.image) {
            console.log("Immagine trovata:", data.image);
            document.getElementById("productImage").src = data.image;
            document.getElementById("productImage").style.display = "block";
            document.getElementById("image-placeholder").style.display = "none";
          } else {
            console.log("Nessuna immagine trovata nel DB.");
            document.getElementById("productImage").style.display = "none";
            document.getElementById("image-placeholder").style.display = "block";
          }

        } else {
          if (barcode) {
            console.log("Prodotto non trovato nel DB. Provo lookup online...");
            fetch(`/lookup_online/${barcode}`)
              .then(response => response.json())
              .then(onlineData => {
                console.log("Risultato lookup online:", onlineData);
                if (onlineData.found) {
                  document.getElementById("name").value = onlineData.name || '';
                  document.getElementById("brand").value = onlineData.brand || '';
                  document.getElementById("quantity").value = onlineData.quantity || 1;

                  if (onlineData.image) {
                    document.getElementById("productImage").src = onlineData.image;
                    document.getElementById("productImage").style.display = "block";
                    document.getElementById("image-placeholder").style.display = "none";
                  } else {
                    document.getElementById("productImage").style.display = "none";
                    document.getElementById("image-placeholder").style.display = "block";
                  }
                }
              })
              .catch(error => console.error("Errore lookup online:", error));
          } else {
            console.log("Nessun barcode disponibile per il lookup online.");
          }
        }
      })
      .catch(error => console.error("Errore lookup DB:", error));
  }
</script>



<!-- --- Terza TAB - LIST: Filtri e inline edit --- -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  // Gestione readonly dei campi consumo medio e frequenza riordino
  document.querySelectorAll('.auto-update-checkbox').forEach(function (checkbox) {
    const row = checkbox.closest('tr');
    const meanUsage = row.querySelector('.mean-usage');
    const reorderFreq = row.querySelector('.reorder-freq');
    function toggleReadonly() {
      const checked = checkbox.checked;
      meanUsage.readOnly = checked;
      reorderFreq.readOnly = checked;
    }
    checkbox.addEventListener('change', function () {
      toggleReadonly();
      showSave(row);
    });
    toggleReadonly();

  // Gestione abilitazione/disabilitazione filtro stagione in base a necessity
    document.querySelectorAll('select.table-select-necessity').forEach(selectNecessity => {
      function toggleSeason() {
        const row = selectNecessity.closest('tr');
        const seasonSelect = row.querySelector('select.table-select-season');
        if (selectNecessity.value === 'Stagionale') {
          seasonSelect.disabled = false;
        } else {
          seasonSelect.disabled = true;
          seasonSelect.value = '';
        }
      }
      // inizializza al caricamento
      toggleSeason();

      // aggiorna al cambio di necessity
      selectNecessity.addEventListener('change', () => {
        toggleSeason();
        const row = selectNecessity.closest('tr');
        showSave(row);
      });
    });
 });

  // Mostra il tasto Salva quando una cella viene modificata
  document.querySelectorAll('.inline-edit, .select-editable, .auto-update-checkbox').forEach(function (input) {
    input.addEventListener('input', function () {
      const row = input.closest('tr');
      showSave(row);
    });
  });

  // Gestione click sul tasto Salva
  document.querySelectorAll('.save-row-btn').forEach(function (btn) {
    btn.addEventListener('click', function () {
      const row = btn.closest('tr');
      const barcode = row.dataset.barcode;
      // Raccogli tutti i valori dei campi modificabili
      const data = {
        barcode: barcode,
        necessity_level: row.querySelector('select.table-select-necessity').value,
        season: row.querySelector('select.table-select-season').value,
        min_quantity: row.querySelector('input[data-field="min_quantity"]').value,
        max_quantity: row.querySelector('input[data-field="max_quantity"]').value,
        security_quantity: row.querySelector('input[data-field="security_quantity"]').value,
        reorder_point: row.querySelector('input[data-field="reorder_point"]').value,
        mean_usage_time: row.querySelector('input[data-field="mean_usage_time"]').value,
        reorder_frequency: row.querySelector('input[data-field="reorder_frequency"]').value,
        user_override: row.querySelector('.auto-update-checkbox').checked ? 1 : 0
      };

      // Soft check logico
      let warning = "";
      if (Number(data.min_quantity) > Number(data.max_quantity)) {
        warning += "La scorta minima √® maggiore della scorta massima.\n";
      }
      if (Number(data.security_quantity) >= Number(data.max_quantity)) {
        warning += "La scorta di sicurezza √® maggiore o uguale alla scorta massima.\n";
      }
      if (Number(data.reorder_point) >= Number(data.max_quantity)) {
        warning += "Il punto di riordino √® maggiore o uguale alla scorta massima.\n";
      }
      if (warning) {
        alert("Attenzione:\n" + warning + "Il salvataggio verr√† comunque effettuato.");
      }

      fetch('/products/update_inline', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(res => {
        console.log("Risposta fetch (grezza):", res);
        return res.json(); // importante!
      })
      .then(data => {
        console.log("Dati ricevuti:", data);
        btn.style.display = 'none';
        let icon = document.createElement('span');
        icon.style.fontSize = '1.5em';
        icon.style.marginLeft = '5px';
        if (data.success) {
          icon.textContent = 'üòä';
          icon.style.color = 'green';
          // Aggiorna la cella 'priority' se presente nella risposta
          if (data.priority_level !== null && data.priority_level !== undefined) {
            const row = btn.closest('tr'); // prendi la riga in cui si trova il bottone premuto
            const priorityCell = row.querySelector('.priority-cell');
            if (priorityCell) {
              priorityCell.textContent = data.priority_level;
            }
          }
        } else {
          icon.textContent = 'üòû';
          icon.style.color = 'red';
        }
        btn.parentNode.appendChild(icon);
        setTimeout(() => {
          icon.remove();
        }, 2000);
      });
    });
  });

  // Funzione per mostrare il tasto Salva
  function showSave(row) {
    const btn = row.querySelector('.save-row-btn');
    if (btn) btn.style.display = '';
  }
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // --- FILTRO DINAMICO SOLO SUL NOME ---
  function populateNameFilter() {
    const nameSet = new Set();

    // Assicurati che la tabella abbia id="list-table"
    document.querySelectorAll('#list-table tbody tr').forEach(row => {
      const name = row.children[1].textContent.trim();  // Colonna Nome
      if (name) nameSet.add(name);
    });

    const filterName = document.getElementById('filterNameList');
    filterName.innerHTML = '<option value="">Tutti</option>';
    Array.from(nameSet).sort().forEach(name => {
      filterName.innerHTML += `<option value="${name}">${name}</option>`;
    });
  }

  // --- FILTRAGGIO TABELLA ---
  function filterTable() {
    const nameVal = document.getElementById('filterNameList').value;

    document.querySelectorAll('#list-table tbody tr').forEach(row => {
      const name = row.children[1].textContent.trim(); // Colonna Nome
      let show = true;
      if (nameVal && name !== nameVal) show = false;
      row.style.display = show ? '' : 'none';
    });
  }

  // Popola solo il filtro Nome (necessity √® fisso in HTML)
  populateNameFilter();

  // Event listeners
  document.getElementById('filterNameList').addEventListener('change', filterTable);

});
</script>



{% endblock %}
